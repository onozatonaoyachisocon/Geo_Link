<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>J-Quake</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸŒŠ</text></svg>">
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- html2canvas -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">

<style>
    :root {
        --bg-color: #121212; --panel-bg: #1e1e1e; --text-main: #e0e0e0;
        --accent-blue: #2196F3;
        --sidebar-width: 320px;
        --tsunami-major: #aa00aa;
        --tsunami-warn: #ff2800;
        --tsunami-adv: #f2e700;
    }
    body, html { margin: 0; padding: 0; height: 100%; font-family: 'Noto Sans JP', sans-serif; background-color: var(--bg-color); color: var(--text-main); overflow: hidden; }

    /* Layout */
    #app-container {
        display: grid;
        grid-template-columns: 0px 0px 1fr; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ãƒ¢ãƒ¼ãƒ‰ */
        grid-template-rows: 50px 1fr;
        height: 100vh; width: 100vw;
        transition: grid-template-columns 0.3s ease;
    }
    /* ãƒ”ãƒ³ç•™ã‚ãƒ¢ãƒ¼ãƒ‰æ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    #app-container.pinned {
        grid-template-columns: var(--sidebar-width) 6px 1fr;
    }

    /* Header */
    header {
        grid-column: 1 / 4; background-color: #000; border-bottom: 1px solid #333;
        display: flex; align-items: center; justify-content: space-between; padding: 0 10px; z-index: 20;
    }
    .header-left { display: flex; align-items: center; gap: 10px; }
    .header-right { display: flex; align-items: center; gap: 8px; }
    
    .status-dot { height: 10px; width: 10px; background-color: #bbb; border-radius: 50%; display: inline-block; transition: 0.3s; flex-shrink: 0;}
    .status-connected { background-color: #00e676; box-shadow: 0 0 5px #00e676; }
    .status-error { background-color: #f44336; box-shadow: 0 0 5px #f44336; }
    #clock { font-family: 'Roboto Mono', monospace; font-size: 1.0rem; white-space: nowrap; }
    #station-status { font-size: 0.7rem; color: #888; margin-left: 5px; display:none; }

    /* Buttons */
    button.icon-btn {
        background: #333; border: 1px solid #555; color: #aaa; padding: 6px 10px;
        cursor: pointer; border-radius: 4px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px;
        transition: 0.2s; white-space: nowrap; justify-content: center;
    }
    button.icon-btn:hover { background: #444; color: #fff; }
    button.icon-btn.active { background: var(--accent-blue); color: #fff; border-color: var(--accent-blue); }

    /* Menu Toggle Button */
    #btn-menu-toggle {
        background: transparent; border: none; color: #fff; font-size: 1.5rem; cursor: pointer; padding: 5px;
    }

    /* Sidebar */
    aside {
        grid-row: 2 / 3; grid-column: 1 / 2; background-color: var(--panel-bg);
        overflow-y: auto; display: flex; flex-direction: column;
        border-right: 1px solid #333;
        
        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤(éãƒ”ãƒ³ç•™ã‚)ãƒ¢ãƒ¼ãƒ‰ã®æŒ™å‹• */
        position: absolute; top: 50px; left: 0; bottom: 0; width: var(--sidebar-width);
        transform: translateX(-100%); transition: transform 0.3s ease; z-index: 3000;
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒè¡¨ç¤ºçŠ¶æ…‹ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ */
    aside.visible {
        transform: translateX(0);
        box-shadow: 5px 0 15px rgba(0,0,0,0.5);
    }
    /* ãƒ”ãƒ³ç•™ã‚æ™‚ã¯Gridå†…ã«åã¾ã‚‹ãŸã‚Transformä¸è¦ */
    #app-container.pinned aside {
        position: relative; top: auto; left: auto; bottom: auto;
        transform: none; z-index: 1; border-right: none;
    }

    /* Sidebar Header (Pin) */
    .sidebar-header {
        display: flex; justify-content: space-between; align-items: center;
        padding: 8px 10px; background: #252525; border-bottom: 1px solid #333;
    }
    #btn-pin-sidebar {
        background: transparent; border: 1px solid #555; color: #888; border-radius: 4px; cursor: pointer; padding: 2px 8px; font-size: 0.8rem;
    }
    #btn-pin-sidebar.active { color: var(--accent-blue); border-color: var(--accent-blue); background: rgba(33, 150, 243, 0.1); }

    details.quake-group { border-bottom: 1px solid #333; }
    details.quake-group summary {
        background-color: #252525; padding: 8px 10px; font-size: 0.85rem; font-weight: bold; color: #aaa;
        cursor: pointer; user-select: none; outline: none; display: flex; justify-content: space-between;
    }
    details.quake-group summary:hover { background-color: #333; color: #fff; }
    details.quake-group[open] summary { border-bottom: 1px solid #333; color: var(--accent-blue); }

    .quake-item {
        padding: 10px; border-bottom: 1px solid #333; cursor: pointer; display: flex; gap: 10px; align-items: center;
        border-left: 4px solid transparent; transition: background 0.2s; padding-left: 15px;
    }
    .quake-item:hover { background-color: #2a2a2a; }
    .quake-item.active { background-color: #333; border-left-color: var(--accent-blue); }
    
    .intensity-box {
        width: 32px; height: 32px; display: flex; align-items: center; justify-content: center;
        font-weight: bold; font-size: 1.0rem; border-radius: 4px; color: #000; flex-shrink: 0;
        text-shadow: 0 0 2px rgba(255,255,255,0.5);
    }
    .quake-info { display: flex; flex-direction: column; font-size: 0.85rem; overflow: hidden; }
    .quake-time { color: #888; font-size: 0.75rem; }
    .quake-place { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }

    /* Resizer (Only visible when pinned) */
    #gutter {
        grid-row: 2 / 3; grid-column: 2 / 3; background: #111; cursor: col-resize;
        border-left: 1px solid #333; border-right: 1px solid #333; z-index: 100;
        display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆéè¡¨ç¤º */
    }
    #app-container.pinned #gutter { display: block; }

    /* Map Area */
    main { grid-column: 3 / 4; grid-row: 2 / 3; position: relative; background: #000; width: 100%; height: 100%; }
    #map { width: 100%; height: 100%; z-index: 1; }
    
    .crosshair-cursor { cursor: crosshair !important; }

    /* Panels on Map */
    #latest-info-panel {
        position: absolute; top: 10px; left: 10px; width: 240px; max-width: 60vw;
        background: rgba(0, 0, 0, 0.85); border: 1px solid #444; border-radius: 8px;
        padding: 10px; z-index: 1000; pointer-events: none; backdrop-filter: blur(5px);
    }
    .panel-row { display: flex; justify-content: space-between; align-items: baseline; }
    .big-place { font-size: 1.2rem; font-weight: bold; margin: 5px 0; }
    .mag-depth { font-family: 'Roboto Mono', monospace; color: #bbb; font-size: 0.85rem; }
    .shindo-display { display: flex; align-items: center; gap: 10px; margin-top: 5px; background: #222; padding: 5px 10px; border-radius: 4px; }

    /* Floating Tool Panel */
    #map-tool-container {
        position: absolute; bottom: 25px; left: 10px; z-index: 1200;
        display: flex; flex-direction: column-reverse; align-items: flex-start;
    }
    #tool-toggle-btn {
        background: rgba(30, 30, 30, 0.9); border: 1px solid #555; color: #fff;
        padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold;
        display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        transition: background 0.2s; font-size: 0.9rem;
    }
    #tool-toggle-btn.pinned { background: var(--accent-blue); border-color: var(--accent-blue); }
    #tool-panel-content {
        margin-bottom: 10px; background: rgba(30, 30, 30, 0.95); border: 1px solid #444;
        border-radius: 8px; padding: 10px; width: 170px;
        backdrop-filter: blur(5px); display: none; flex-direction: column; gap: 8px; 
        box-shadow: 0 4px 15px rgba(0,0,0,0.6);
    }
    
    .tool-section-label { font-size: 0.7rem; color: #888; border-bottom: 1px solid #444; margin-bottom: 4px; padding-bottom: 2px;}
    .tool-row { display: flex; flex-direction: column; gap: 4px; }
    .tool-control { width: 100%; box-sizing: border-box; background: #222; border: 1px solid #444; color: #fff; padding: 4px; border-radius: 4px; font-size: 0.85rem; }
    
    /* GPS Button */
    #btn-gps-main {
        position: absolute; bottom: 100px; right: 10px; z-index: 1000;
        width: 40px; height: 40px; background: #fff; color: #000;
        border: 2px solid rgba(0,0,0,0.2); border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        font-size: 1.5rem; transition: background 0.2s;
    }
    #btn-gps-main:hover { background: #f0f0f0; }
    #btn-gps-main:active { background: #ddd; }

    /* Tsunami Panel */
    #tsunami-panel {
        display: none; position: absolute; top: 90px; left: 50%; transform: translateX(-50%); width: 350px; max-width: 90%;
        background: rgba(0, 0, 50, 0.95); border: 2px solid var(--accent-blue); border-radius: 8px;
        padding: 10px; z-index: 1500; color: #fff; text-align: center;
        box-shadow: 0 0 20px rgba(0,0,0,0.8);
    }
    .tsunami-header { 
        font-weight: bold; font-size: 1.1rem; border-bottom: 1px solid #444; 
        padding-bottom: 5px; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; 
    }
    .close-tsunami-btn { background: transparent; border: none; color: #aaa; font-size: 1.5rem; cursor: pointer; line-height: 1; padding: 0 5px; }

    #eew-overlay {
        position: absolute; top: 150px; right: 10px; width: 280px; max-width:80vw;
        background: rgba(180, 0, 0, 0.9); color: #fff; padding: 10px;
        border-radius: 8px; z-index: 2000; display: none; box-shadow: 0 0 20px rgba(255,0,0,0.5);
        animation: flash 1s infinite alternate;
    }
    
    #personal-alert {
        display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(200, 0, 0, 0.95); color: #fff; padding: 20px; border-radius: 15px;
        text-align: center; z-index: 3000; box-shadow: 0 0 50px rgba(255,0,0,0.8);
        border: 2px solid #ff5252; min-width: 280px; max-width: 90vw;
    }
    #alert-countdown { font-size: 3.5rem; font-weight: bold; font-family: 'Roboto Mono', monospace; }
    #alert-message { font-size: 1.1rem; margin-top: 5px; }
    #alert-est-shindo { font-size: 1.8rem; font-weight: bold; margin-bottom: 10px; background: #fff; color:#d32f2f; display:inline-block; padding:5px 15px; border-radius:5px; }

    #tide-legend {
        display: none; position: absolute; bottom: 30px; right: 10px;
        background: rgba(255, 255, 255, 0.9); color: #000;
        padding: 5px; border-radius: 5px; border: 1px solid #999;
        z-index: 1000; font-size: 0.75rem; box-shadow: 0 0 10px rgba(0,0,0,0.5); width: 140px;
    }
    .legend-item { display: flex; align-items: center; gap: 5px; margin-bottom: 2px; }
    .legend-icon { width: 14px; height: 14px; display: inline-block; flex-shrink: 0; }
    .leaflet-interactive { cursor: pointer; }

    @keyframes flash { from { opacity: 1; } to { opacity: 0.8; } }

    /* Modal */
    #modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 9999;
    }
    #modal-window {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #222; width: 500px; max-width: 95%; max-height: 90vh; overflow-y: auto;
        border-radius: 8px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        border: 1px solid #444;
    }
    .modal-header { 
        font-size: 1.1rem; font-weight: bold; margin-bottom: 10px; 
        border-bottom: 1px solid #444; padding-bottom: 5px; display:flex; 
        justify-content:space-between; cursor: move; user-select: none;
    }
    .form-group { margin-bottom: 10px; background: #2a2a2a; padding: 10px; border-radius: 5px; }
    .form-label { display: block; margin-bottom: 5px; color: #aaa; font-size: 0.85rem; }
    
    .loc-list-item { display: flex; justify-content: space-between; align-items: center; background: #333; padding: 5px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9rem;}
    .btn-primary { background: var(--accent-blue); color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; }
    .btn-cancel { background: #444; color: #ddd; border: none; padding: 8px; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 10px; }
    .btn-close { background:transparent; border:none; color:#888; font-size:1.5rem; cursor:pointer;}
    .btn-row { display: flex; gap: 10px; margin-top: 15px; }

    input[type="number"], input[type="text"], select { background: #333; border: 1px solid #555; color: #fff; padding: 5px; border-radius: 4px; width: 100%; box-sizing: border-box; }
    input[type="color"] { background: none; border: none; width: 30px; height: 30px; cursor: pointer; }
    .color-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .color-item { display: flex; align-items: center; gap: 10px; background: #333; padding: 5px; border-radius: 4px; font-size: 0.8rem; }

/* Help Modal Specific Styles */
    #help-modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 9999; backdrop-filter: blur(2px);
    }
    #help-modal-window {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: #1e1e1e; width: 600px; max-width: 95%; max-height: 85vh; overflow-y: auto;
        border-radius: 12px; padding: 0; box-shadow: 0 15px 40px rgba(0,0,0,0.9);
        border: 1px solid #444; display: flex; flex-direction: column;
    }
    #help-modal-window .modal-header {
        padding: 15px 20px; background: #252525; border-bottom: 1px solid #333;
        position: sticky; top: 0; z-index: 10; display: flex; align-items: center; justify-content: space-between;
    }
    .help-content { padding: 20px; font-size: 0.95rem; line-height: 1.6; color: #ddd; }
    .help-content section { margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 20px; }
    .help-content section:last-child { border-bottom: none; margin-bottom: 0; }
    .help-content h3 { margin-top: 0; margin-bottom: 10px; color: #fff; font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .help-content ul { padding-left: 20px; margin: 10px 0; }
    .help-content li { margin-bottom: 5px; }
    
    /* Scrollbar customized for modal */
    #help-modal-window::-webkit-scrollbar { width: 8px; }
    #help-modal-window::-webkit-scrollbar-track { background: #1e1e1e; }
    #help-modal-window::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }
    #help-modal-window::-webkit-scrollbar-thumb:hover { background: #555; }

</style>
</head>
<body>
<div id="app-container">
<header>
    <div class="header-left">
        <button id="btn-menu-toggle" title="ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤ºåˆ‡æ›¿">â˜°</button>
        <h1><span id="conn-status" class="status-dot"></span> J-Quake</h1>
        <div id="clock">00:00:00</div>
        <div id="station-status"></div>
    </div>
    <div class="header-right">
        <select id="header-loc-select" title="ç™»éŒ²åœ°ç‚¹ã¸ã‚¸ãƒ£ãƒ³ãƒ—" style="max-width:120px; font-size:0.8rem;">
            <option value="">ğŸ“ åœ°ç‚¹...</option>
        </select>
        <button id="btn-settings" class="icon-btn">âš™ï¸</button>
<button id="btn-help" class="icon-btn" title="ãƒ˜ãƒ«ãƒ—">â“</button>
    </div>
</header>

<!-- Sidebar -->
<aside id="quake-list-area">
    <div class="sidebar-header">
        <span style="font-size:0.8rem; color:#aaa;">åœ°éœ‡å±¥æ­´</span>
        <button id="btn-pin-sidebar" title="ãƒªã‚¹ãƒˆã‚’ãƒ”ãƒ³ç•™ã‚ï¼ˆåœ°å›³ã‚’åˆ†å‰²ï¼‰">ğŸ“Œ ãƒ”ãƒ³ç•™ã‚</button>
    </div>
    <div id="list-container"></div>
    <div style="display: flex; border-top: 1px solid #333; margin-top:auto;">
        <button id="btn-load-more" style="flex:1; padding:12px; background:#222; border:none; color:#888; cursor:pointer;">ã•ã‚‰ã«èª­ã¿è¾¼ã‚€</button>
    </div>
</aside>

<!-- Resizer -->
<div id="gutter"></div>

<!-- Map Area -->
<main>
    <!-- Map Tool Panel (Floating) -->
    <div id="map-tool-container">
        <div id="tool-toggle-btn">ğŸ› ï¸ è¡¨ç¤ºãƒ»ãƒ„ãƒ¼ãƒ«</div>
        <div id="tool-panel-content">
            <div class="tool-section-label">çµã‚Šè¾¼ã¿</div>
            <div class="tool-row">
                <select id="filter-min-shindo" class="tool-control">
                    <option value="0">å…¨è¡¨ç¤º</option>
                    <option value="30">éœ‡åº¦3ä»¥ä¸Š</option>
                    <option value="40">éœ‡åº¦4ä»¥ä¸Š</option>
                </select>
            </div>

            <div class="tool-section-label">ãƒãƒƒãƒ—è¡¨ç¤º</div>
            <div class="tool-row">
                <button id="btn-points-toggle" class="icon-btn active" style="width:100%">ğŸ“ è¦³æ¸¬ç‚¹</button>
                <button id="btn-tide-toggle" class="icon-btn" style="width:100%">ğŸŒŠ æ½®ä½è¦³æ¸¬</button>
            </div>

            <div class="tool-section-label">è¿½å°¾</div>
            <div class="tool-row">
                <button id="btn-auto-zoom" class="icon-btn active" style="width:100%">ğŸ¯ æ–°ç€è¿½å°¾</button>
                <button id="btn-list-zoom" class="icon-btn" style="width:100%">ğŸ‘† ã‚¯ãƒªãƒƒã‚¯</button>
            </div>

            <div class="tool-section-label">ãã®ä»–</div>
            <div class="tool-row">
                <button id="btn-audio" class="icon-btn" style="width:100%">ğŸ”‡ éŸ³å£°</button>
                <button id="btn-screenshot" class="icon-btn" style="width:100%">ğŸ“· ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- GPS Button -->
    <button id="btn-gps-main" title="ç¾åœ¨åœ°ã¸ç§»å‹•">â—</button>

    <!-- Tsunami Panel -->
    <div id="tsunami-panel">
        <div class="tsunami-header">
            <span>ğŸŒŠ æ´¥æ³¢æƒ…å ±</span>
            <button class="close-tsunami-btn" onclick="clearTsunamiData()" title="æƒ…å ±ã‚’æ¶ˆå»">Ã—</button>
        </div>
        <div id="tsunami-content">ç¾åœ¨ã€æ´¥æ³¢è­¦å ±ç­‰ã¯ç™ºè¡¨ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
    </div>

    <!-- Info Panel -->
    <div id="latest-info-panel">
        <div class="panel-row">
            <span style="color:#aaa; font-size:0.75rem;">ç™ºç”Ÿæ™‚åˆ»</span>
            <span id="p-time" class="mag-depth">--/-- --:--</span>
        </div>
        <div id="p-place" class="big-place">ãƒ‡ãƒ¼ã‚¿å¾…æ©Ÿä¸­</div>
        <div style="margin-top:2px; display:flex; flex-direction:column; gap:0px;">
            <span id="p-mag" class="mag-depth">ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰ ---</span>
            <span id="p-depth" class="mag-depth">éœ‡æºã®æ·±ã• ---</span>
        </div>
        <div class="shindo-display">
            <div id="p-shindo-box" class="intensity-box" style="background:#444;">-</div>
            <div id="p-shindo-text" style="font-size:1.2rem; font-weight:bold;">-</div>
        </div>
    </div>

    <div id="eew-overlay">
        <div style="font-weight:bold; font-size:1.1rem;">âš ï¸ ç·Šæ€¥åœ°éœ‡é€Ÿå ±</div>
        <div id="eew-text" style="margin-top:5px; font-size:0.9rem;">è©³ç´°ã‚’å—ä¿¡ä¸­...</div>
    </div>

    <div id="personal-alert">
        <div id="alert-location-name">ç¾åœ¨åœ°</div>
        <div style="font-size:0.9rem; margin-bottom:5px;">äºˆæƒ³éœ‡åº¦</div>
        <div id="alert-est-shindo">éœ‡åº¦4</div>
        <div style="font-size:0.9rem;">åˆ°é”ã¾ã§</div>
        <div id="alert-countdown">0</div>
        <div id="alert-message">æºã‚Œã«å‚™ãˆã¦ãã ã•ã„</div>
        <button onclick="stopAlert()" style="background:#fff; color:#000; border:none; padding:5px 10px; margin-top:10px; border-radius:4px; cursor:pointer;">é–‰ã˜ã‚‹</button>
    </div>

    <!-- æ½®ä½å‡¡ä¾‹ -->
    <div id="tide-legend">
        <div style="font-weight:bold; margin-bottom:2px; border-bottom:1px solid #ccc; text-align:center;">å‡¡ä¾‹</div>
        <div class="legend-item"><span class="legend-icon" id="leg-jma"></span> æ°—è±¡åº</div>
        <div class="legend-item"><span class="legend-icon" id="leg-jcg"></span> æµ·ä¸Šä¿å®‰åº</div>
        <div class="legend-item"><span class="legend-icon" id="leg-gsi"></span> å›½åœŸåœ°ç†é™¢</div>
        <div class="legend-item"><span class="legend-icon" id="leg-port"></span> æ¸¯æ¹¾å±€</div>
        <div class="legend-item"><span class="legend-icon" id="leg-riv"></span> æ°´ç®¡ç†ãƒ»å›½åœŸ</div>
        <div class="legend-item"><span class="legend-icon" id="leg-pref"></span> è‡ªæ²»ä½“ç­‰</div>
    </div>

    <div id="map"></div>
</main>
</div>

<!-- Modal Settings -->
<div id="modal-overlay">
<div id="modal-window">
<div class="modal-header" id="modal-header-drag">
    <span>è¨­å®š</span>
    <button class="btn-close" id="modal-close">Ã—</button>
</div>

<div class="form-group">
    <label class="form-label" style="font-weight:bold; color:#2196F3;">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</label>
    <div style="display:flex; gap:10px;">
        <button class="icon-btn" onclick="exportConfig()" style="flex:1; justify-content:center;">ğŸ“¤ ä¿å­˜</button>
        <button class="icon-btn" onclick="document.getElementById('import-file').click()" style="flex:1; justify-content:center;">ğŸ“¥ èª­è¾¼</button>
        <input type="file" id="import-file" style="display:none" onchange="importConfig(this)">
    </div>
</div>

<div class="form-group">
    <label class="form-label" style="font-weight:bold; color:#2196F3;">ğŸ“ ãƒã‚¤ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³</label>
    <div id="settings-loc-list" style="margin-bottom:10px;"></div>
    <div style="display:grid; grid-template-columns: 2fr 1.5fr 1.5fr 1fr; gap:5px; align-items:end;">
        <div><label class="form-label">åç§°</label><input type="text" id="new-loc-name" placeholder="è‡ªå®…"></div>
        <div><label class="form-label">ç·¯åº¦</label><input type="number" id="new-loc-lat" step="0.0001" placeholder="35.xxxx"></div>
        <div><label class="form-label">çµŒåº¦</label><input type="number" id="new-loc-lon" step="0.0001" placeholder="139.xxxx"></div>
        <button class="icon-btn" onclick="addLocation()" style="justify-content:center;">ï¼‹</button>
    </div>
    <div style="display:flex; gap:5px; margin-top:5px;">
        <button class="icon-btn" onclick="startMapPick()" style="flex:1; justify-content:center; background:#283593;">ğŸ—ºï¸ åœ°å›³æŒ‡å®š</button>
        <button class="icon-btn" onclick="getCurrentLocationForInput()" style="flex:1; justify-content:center;">ğŸ“¡ GPSå–å¾—</button>
    </div>
</div>

<div class="form-group">
    <label class="form-label">é€šçŸ¥ã™ã‚‹æœ€å°éœ‡åº¦ï¼ˆäºˆæ¸¬ï¼‰</label>
    <select id="input-alert-threshold">
        <option value="10">éœ‡åº¦1ä»¥ä¸Š</option>
        <option value="30" selected>éœ‡åº¦3ä»¥ä¸Š</option>
        <option value="40">éœ‡åº¦4ä»¥ä¸Š</option>
    </select>
</div>

<div class="form-group">
    <label class="form-label">éœ‡åº¦åˆ¥ã‚«ãƒ©ãƒ¼</label>
    <div class="color-grid" id="color-settings-grid"></div>
</div>

<div class="form-group">
    <label class="form-label">ãƒ‡ãƒ¢å®Ÿè¡Œ</label>
    <div style="display:flex; gap:10px;">
        <button class="icon-btn" onclick="demoEEW()" style="flex:1; justify-content:center; background:#b71c1c;">âš ï¸ EEWãƒ‡ãƒ¢</button>
        <button class="icon-btn" onclick="demoTsunami()" style="flex:1; justify-content:center; background:#006064;">ğŸŒŠ æ´¥æ³¢ãƒ‡ãƒ¢</button>
    </div>
</div>

<div class="btn-row">
    <button class="btn-cancel" id="btn-cancel-settings">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    <button class="btn-primary" id="btn-save-settings">ä¿å­˜</button>
</div>
</div>
</div>

<script>
// --- Configuration & Default Settings ---
const DEFAULT_CONFIG = {
    version: 5,
    markerBaseSize: 5,
    colors: {
        10: "#4caf50", 20: "#8bc34a", 30: "#ffeb3b", 40: "#ffc107",
        45: "#ff9800", 50: "#ff5722", 55: "#e91e63", 60: "#d32f2f", 70: "#b71c1c"
    },
    savedLocations: [{ name: "æ±äº¬é§…", lat: 35.6812, lon: 139.7671 }],
    alertThreshold: 30,
    sWaveSpeed: 4.0
};

let config;
try {
    const stored = localStorage.getItem("jq_config_v5");
    config = stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(DEFAULT_CONFIG));
} catch (e) { config = JSON.parse(JSON.stringify(DEFAULT_CONFIG)); }
let configBackup = null;

// --- Global Variables ---
const WS_URL = "wss://api.p2pquake.net/v2/ws";
const HISTORY_API = "https://api.p2pquake.net/v2/history?codes=551";
const JAPAN_GEOJSON_URL = "https://raw.githubusercontent.com/dataofjapan/land/master/japan.geojson";

const STATION_LOCATIONS = { 
    "åŒ—æµ·é“æœ­å¹Œå¸‚ä¸­å¤®åŒº": {lat: 43.062, lon: 141.354}, 
    "æ±äº¬éƒ½åƒä»£ç”°åŒº": {lat: 35.694, lon: 139.754}, 
    "æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­åŒº": {lat: 35.180, lon: 136.906},
    "å¤§é˜ªåºœå¤§é˜ªå¸‚ä¸­å¤®åŒº": {lat: 34.693, lon: 135.502},
    "ç¦å²¡çœŒç¦å²¡å¸‚åšå¤šåŒº": {lat: 33.606, lon: 130.418}
};

let map;
let markers = {};
let quakeData = [];
let fetchOffset = 0;
let isAudioOn = false;
let isAutoZoom = true;
let isListClickZoom = false;
let isPointsVisible = true;
let isPickingLocation = false; 
let socket = null;
let alertTimerInterval = null;
let isToolLocked = false;
let isTideVisible = false;

// Sidebar State
let isSidebarPinned = false; 
let isSidebarVisible = false; 

let pWaveLayer, sWaveLayer, currentWaveTarget, pointsLayerGroup, tsunamiLayerGroup, tideLayerGroup, geoJsonData;
let userLocationMarkers = [];

// â–¼ Raw Tide Data (Full Restoration) â–¼
const TIDE_STATIONS_RAW = `
1	æå¹¸	æ¸¯æ¹¾å±€	åŒ—æµ·é“ æå¹¸éƒ¡ æå¹¸ç”º å¹¸ç”º	44Â°56â€²	142Â°35â€²
2	æ²“å½¢	æ¸¯æ¹¾å±€	åŒ—æµ·é“ åˆ©å°»éƒ¡ åˆ©å°»ç”º æ²“å½¢	45Â°11â€²	141Â°8â€²
3	ç¨šå†…	æ°—è±¡åº	åŒ—æµ·é“ ç¨šå†…å¸‚ æ–°æ¸¯ç”º	45Â°24â€²	141Â°41â€²
4	ç•™èŒ	æ¸¯æ¹¾å±€	åŒ—æµ·é“ ç•™èŒå¸‚ å¤§ç”ºï¼‘ä¸ç›®	43Â°57â€²	141Â°38â€²
5	çŸ³ç‹©æ–°æ¸¯	æ¸¯æ¹¾å±€	åŒ—æµ·é“ çŸ³ç‹©å¸‚ æ–°æ¸¯æ±ï¼”ä¸ç›®	43Â°13â€²	141Â°18â€²
6	å²©å†…	æ¸¯æ¹¾å±€	åŒ—æµ·é“ å²©å†…éƒ¡ å²©å†…ç”º å¾¡å´	42Â°59â€²	140Â°30â€²
7	å¿è·¯	å›½åœŸåœ°ç†é™¢	åŒ—æµ·é“ å°æ¨½å¸‚ å¿è·¯ï¼‘ä¸ç›®	43Â°13â€²	140Â°52â€²
8	å°æ¨½	æ°—è±¡åº	åŒ—æµ·é“ å°æ¨½å¸‚ ç¯‰æ¸¯	43Â°11â€²	141Â°1â€²
9	ç´‹åˆ¥	æ¸¯æ¹¾å±€	åŒ—æµ·é“ ç´‹åˆ¥å¸‚ å¼å¤©ç”º	44Â°21â€²	143Â°22â€²
10	ç¶²èµ°	æ°—è±¡åº	åŒ—æµ·é“ ç¶²èµ°å¸‚ æ¸¯ç”º	44Â°1â€²	144Â°17â€²
11	æ ¹å®¤	æ¸¯æ¹¾å±€	åŒ—æµ·é“ æ ¹å®¤å¸‚ æµ·å²¸ç”ºï¼’ä¸ç›®	43Â°21â€²	145Â°35â€²
12	èŠ±å’²	æ°—è±¡åº	åŒ—æµ·é“ æ ¹å®¤å¸‚ èŠ±å’²æ¸¯	43Â°17â€²	145Â°34â€²
13	éœ§å¤šå¸ƒ	æ¸¯æ¹¾å±€	åŒ—æµ·é“ åšå²¸éƒ¡ æµœä¸­ç”º éœ§å¤šå¸ƒ	43Â°5â€²	145Â°7â€²
14	é‡§è·¯	æ°—è±¡åº	åŒ—æµ·é“ é‡§è·¯å¸‚ æ¸¯ç”º	42Â°59â€²	144Â°22â€²
15	åå‹	æ¸¯æ¹¾å±€	åŒ—æµ·é“ åºƒå°¾éƒ¡ åºƒå°¾ç”º ä¼šæ‰€å‰	42Â°18â€²	143Â°19â€²
16	è‹«å°ç‰§æ±	æ¸¯æ¹¾å±€	åŒ—æµ·é“ å‹‡æ‰•éƒ¡ åšçœŸç”º æµœåšçœŸ	42Â°36â€²	141Â°49â€²
17	è‹«å°ç‰§è¥¿	æ¸¯æ¹¾å±€	åŒ—æµ·é“ è‹«å°ç‰§å¸‚ æ±è¦‹ç”ºï¼‘ä¸ç›®	42Â°38â€²	141Â°37â€²
18	å®¤è˜­	æ¸¯æ¹¾å±€	åŒ—æµ·é“ å®¤è˜­å¸‚ ç¥æ´¥ç”ºï¼‘ä¸ç›®	42Â°21â€²	140Â°57â€²
19	ç™½è€	æ¸¯æ¹¾å±€	åŒ—æµ·é“ ç™½è€éƒ¡ ç™½è€ç”º çŸ³å±±	42Â°31â€²	141Â°19â€²
20	æµ¦æ²³	æ¸¯æ¹¾å±€	åŒ—æµ·é“ æµ¦æ²³éƒ¡ æµ¦æ²³ç”º å¤§é€šï¼‘ä¸ç›®	42Â°10â€²	142Â°46â€²
21	æ£®	æ¸¯æ¹¾å±€	åŒ—æµ·é“ èŒ…éƒ¨éƒ¡ æ£®ç”º æ¸¯ç”º	42Â°7â€²	140Â°36â€²
22	å‡½é¤¨	æ°—è±¡åº	åŒ—æµ·é“ å‡½é¤¨å¸‚ æµ·å²¸ç”º	41Â°47â€²	140Â°43â€²
23	ç€¬æ£š	æ¸¯æ¹¾å±€	åŒ—æµ·é“ ä¹…é éƒ¡ ã›ãŸãªç”º ç€¬æ£šåŒº æœ¬ç”º	42Â°27â€²	139Â°51â€²
24	å¥¥å°»	å›½åœŸåœ°ç†é™¢	åŒ—æµ·é“ å¥¥å°»éƒ¡ å¥¥å°»ç”º æ¾æ±Ÿ	42Â°5â€²	139Â°29â€²
25	å¥¥å°»æ¸¯	æ¸¯æ¹¾å±€	åŒ—æµ·é“ å¥¥å°»éƒ¡ å¥¥å°»ç”º å¥¥å°»	42Â°10â€²	139Â°31â€²
26	æ±Ÿå·®	æ¸¯æ¹¾å±€	åŒ—æµ·é“ æªœå±±éƒ¡ æ±Ÿå·®ç”º ä¸­æ­Œç”º	41Â°52â€²	140Â°8â€²
27	é’æ£®	æ¸¯æ¹¾å±€	é’æ£®çœŒ é’æ£®å¸‚ æ¸¯ç”º	40Â°50â€²	140Â°46â€²
28	æµ…è™«	å›½åœŸåœ°ç†é™¢	é’æ£®çœŒ é’æ£®å¸‚ æµ…è™«	40Â°54â€²	140Â°52â€²
29	å…«æˆ¸æ¸¯	æ¸¯æ¹¾å±€	é’æ£®çœŒ å…«æˆ¸å¸‚ é®«ç”º	40Â°32â€²	141Â°33â€²
30	ä¸‹åŒ—	æ°—è±¡åº	é’æ£®çœŒ ã‚€ã¤å¸‚ é–¢æ ¹	41Â°22â€²	141Â°14â€²
31	æ·±æµ¦	æ°—è±¡åº	é’æ£®çœŒ è¥¿æ´¥è»½éƒ¡ æ·±æµ¦ç”º æ·±æµ¦	40Â°39â€²	139Â°56â€²
32	ç«œé£›	æµ·ä¸Šä¿å®‰åº	é’æ£®çœŒ æ±æ´¥è»½éƒ¡ å¤–ãƒ¶æµœç”º ä¸‰å©æ¢¨ãƒæœ¨é–“	41Â°15â€²	140Â°23â€²
33	ã‚€ã¤å°å·åŸ	æ¸¯æ¹¾å±€	é’æ£®çœŒ ä¸ŠåŒ—éƒ¡ å…­ãƒ¶æ‰€æ‘ é·¹æ¶	40Â°56â€²	141Â°23â€²
34	ç”·é¹¿	å›½åœŸåœ°ç†é™¢	ç§‹ç”°çœŒ ç”·é¹¿å¸‚ æˆ¸è³€å¡©æµœ	39Â°57â€²	139Â°42â€²
35	ç§‹ç”°	æ¸¯æ¹¾å±€	ç§‹ç”°çœŒ ç§‹ç”°å¸‚ åœŸå´è¥¿ï¼‘ä¸ç›®	39Â°45â€²	140Â°4â€²
36	å®®å¤	æ°—è±¡åº	å²©æ‰‹çœŒ å®®å¤å¸‚ æ—¥ç«‹æµœç”º	39Â°39â€²	141Â°59â€²
37	å¤§èˆ¹æ¸¡	æ°—è±¡åº	å²©æ‰‹çœŒ å¤§èˆ¹æ¸¡å¸‚ èµ¤å´ç”º	39Â°1â€²	141Â°45â€²
38	é‡œçŸ³	æµ·ä¸Šä¿å®‰åº	å²©æ‰‹çœŒ é‡œçŸ³å¸‚ é­šæ²³å²¸ç”º	39Â°16â€²	141Â°53â€²
39	ä¹…æ…ˆ	æ¸¯æ¹¾å±€	å²©æ‰‹çœŒ ä¹…æ…ˆå¸‚ é•·å†…ç”º	40Â°12â€²	141Â°48â€²
40	çŸ³å·»	æ¸¯æ¹¾å±€	å®®åŸçœŒ çŸ³å·»å¸‚ è¥¿æµœç”ºåœ°å…ˆ	38Â°24â€²	141Â°16â€²
41	ä»™å°æ–°æ¸¯	æ¸¯æ¹¾å±€	å®®åŸçœŒ ä»™å°å¸‚ å®®åŸé‡åŒº æ¸¯ï¼“ä¸ç›®	38Â°16â€²	141Â°0â€²
42	é®å·	æ°—è±¡åº	å®®åŸçœŒ çŸ³å·»å¸‚ é®å·æµœ	38Â°18â€²	141Â°30â€²
43	é¼ ãƒ¶é–¢	å›½åœŸåœ°ç†é™¢	å±±å½¢çœŒ é¶´å²¡å¸‚ é¼ ãƒ¶é–¢	38Â°34â€²	139Â°33â€²
44	é£›å³¶	å›½åœŸåœ°ç†é™¢	å±±å½¢çœŒ é…’ç”°å¸‚ é£›å³¶	39Â°11â€²	139Â°33â€²
45	é…’ç”°	æ¸¯æ¹¾å±€	å±±å½¢çœŒ é…’ç”°å¸‚ å®®é‡æµ¦	38Â°55â€²	139Â°49â€²
46	ç›¸é¦¬	å›½åœŸåœ°ç†é™¢	ç¦å³¶çœŒ ç›¸é¦¬å¸‚ åŸé‡œ	37Â°50â€²	140Â°58â€²
47	å°åæµœ	æ°—è±¡åº	ç¦å³¶çœŒ ã„ã‚ãå¸‚ å°åæµœ	36Â°56â€²	140Â°54â€²
48	é¹¿å³¶	æ¸¯æ¹¾å±€	èŒ¨åŸçœŒ ç¥æ –å¸‚ å±…åˆ‡	35Â°56â€²	140Â°42â€²
49	æ±äº¬	æ°—è±¡åº	æ±äº¬éƒ½ ä¸­å¤®åŒº æ™´æµ·ï¼•ä¸ç›®	35Â°39â€²	139Â°46â€²
50	å²¡ç”°	æ°—è±¡åº	æ±äº¬éƒ½ å¤§å³¶ç”º å²¡ç”°	34Â°47â€²	139Â°23â€²
51	ä¸‰å®…å³¶ï¼ˆåªç”°ï¼‰	æ°—è±¡åº	æ±äº¬éƒ½ ä¸‰å®…æ‘ åªç”°èˆ¹æˆ¸	34Â°3â€²	139Â°33â€²
52	çˆ¶å³¶	æ°—è±¡åº	æ±äº¬éƒ½ å°ç¬ åŸæ‘ çˆ¶å³¶æ±ç”º	27Â°6â€²	142Â°12â€²
53	ç¥æ´¥å³¶	æµ·ä¸Šä¿å®‰åº	æ±äº¬éƒ½ ç¥æ´¥å³¶æ‘ ç¥æ´¥å³¶æ¸¯	34Â°13â€²	139Â°8â€²
54	ä¸‰å®…å³¶ï¼ˆé˜¿å¤ï¼‰	æµ·ä¸Šä¿å®‰åº	æ±äº¬éƒ½ ä¸‰å®…æ‘ é˜¿å¤	34Â°4â€²	139Â°29â€²
55	å…«ä¸ˆå³¶ï¼ˆç¥æ¹Šï¼‰	æµ·ä¸Šä¿å®‰åº	æ±äº¬éƒ½ å…«ä¸ˆç”º ä¸‰æ ¹	33Â°8â€²	139Â°48â€²
56	å‹æµ¦	å›½åœŸåœ°ç†é™¢	åƒè‘‰çœŒ å‹æµ¦å¸‚ èˆˆæ´¥	35Â°8â€²	140Â°15â€²
57	å¸ƒè‰¯	æ°—è±¡åº	åƒè‘‰çœŒ é¤¨å±±å¸‚ å¸ƒè‰¯	34Â°55â€²	139Â°50â€²
58	åƒè‘‰	æµ·ä¸Šä¿å®‰åº	åƒè‘‰çœŒ å¸‚åŸå¸‚ äº”äº•	35Â°34â€²	140Â°3â€²
59	éŠšå­æ¼æ¸¯	åƒè‘‰çœŒ	åƒè‘‰çœŒ éŠšå­å¸‚ å·å£ç”ºï¼’ä¸ç›®	35Â°45â€²	140Â°52â€²
60	äº¬æµœæ¸¯	æ¸¯æ¹¾å±€	ç¥å¥ˆå·çœŒ æ¨ªæµœå¸‚ ç¥å¥ˆå·åŒº å±±å†…ç”º	35Â°28â€²	139Â°38â€²
61	æ²¹å£º	å›½åœŸåœ°ç†é™¢	ç¥å¥ˆå·çœŒ ä¸‰æµ¦å¸‚ ä¸‰å´ç”º	35Â°10â€²	139Â°37â€²
62	å°ç”°åŸ	æ°—è±¡åº	ç¥å¥ˆå·çœŒ å°ç”°åŸå¸‚ æ—©å·åœ°å…ˆ	35Â°14â€²	139Â°9â€²
63	æ¨ªæµœ	æµ·ä¸Šä¿å®‰åº	ç¥å¥ˆå·çœŒ æ¨ªæµœå¸‚ ä¸­åŒº æ–°æ¸¯ç”ºï¼‘ä¸ç›®	35Â°27â€²	139Â°39â€²
64	æ¨ªé ˆè³€	æµ·ä¸Šä¿å®‰åº	ç¥å¥ˆå·çœŒ æ¨ªé ˆè³€å¸‚ è¥¿é€¸è¦‹ç”º	35Â°17â€²	139Â°39â€²
65	ä¼Šæ±	å›½åœŸåœ°ç†é™¢	é™å²¡çœŒ ä¼Šæ±å¸‚ å¯Œæˆ¸	34Â°54â€²	139Â°8â€²
66	ç”°å­	å›½åœŸåœ°ç†é™¢	é™å²¡çœŒ è³€èŒ‚éƒ¡ è¥¿ä¼Šè±†ç”º ç”°å­	34Â°48â€²	138Â°46â€²
67	ç„¼æ´¥	å›½åœŸåœ°ç†é™¢	é™å²¡çœŒ ç„¼æ´¥å¸‚ ä¸­æ¸¯ï¼–ä¸ç›®	34Â°52â€²	138Â°20â€²
68	ä¸‹ç”°	æ¸¯æ¹¾å±€	é™å²¡çœŒ ä¸‹ç”°å¸‚ æŸ¿å´å¼å¤©å³¶åœ°å…ˆ	34Â°41â€²	138Â°58â€²
69	çŸ³å»Šå´	æ°—è±¡åº	é™å²¡çœŒ è³€èŒ‚éƒ¡ å—ä¼Šè±†ç”º æ‰‹çŸ³	34Â°38â€²	138Â°53â€²
70	å†…æµ¦	æ°—è±¡åº	é™å²¡çœŒ æ²¼æ´¥å¸‚ å†…æµ¦é•·æµœç¶²ä»£	35Â°1â€²	138Â°53â€²
71	æ¸…æ°´æ¸¯	æ°—è±¡åº	é™å²¡çœŒ é™å²¡å¸‚ æ¸…æ°´åŒº ä¸‰ä¿	35Â°1â€²	138Â°31â€²
72	å¾¡å‰å´	æ°—è±¡åº	é™å²¡çœŒ å¾¡å‰å´å¸‚ æ¸¯	34Â°37â€²	138Â°13â€²
73	èˆé˜ª	æ°—è±¡åº	é™å²¡çœŒ æµœæ¾å¸‚ ä¸­å¤®åŒº èˆé˜ªç”º	34Â°41â€²	137Â°37â€²
74	è¡£æµ¦	æ„›çŸ¥çœŒ	æ„›çŸ¥çœŒ åŠç”°å¸‚ 11å·åœ°	34Â°53â€²	136Â°57â€²
75	é¬¼å´	å›½åœŸåœ°ç†é™¢	æ„›çŸ¥çœŒ å¸¸æ»‘å¸‚ æ¸¯ç”ºï¼’ä¸ç›®	34Â°54â€²	136Â°49â€²
76	ä¸‰æ²³	æ¸¯æ¹¾å±€	æ„›çŸ¥çœŒ è±Šæ©‹å¸‚ ç¥é‡ãµé ­	34Â°44â€²	137Â°19â€²
77	åå¤å±‹	æ°—è±¡åº	æ„›çŸ¥çœŒ åå¤å±‹å¸‚ æ¸¯åŒº æ¸¯ç”º	35Â°5â€²	136Â°53â€²
78	èµ¤ç¾½æ ¹	æ°—è±¡åº	æ„›çŸ¥çœŒ ç”°åŸå¸‚ æ± å°»ç”º	34Â°36â€²	137Â°11â€²
79	å››æ—¥å¸‚æ¸¯	å››æ—¥å¸‚æ¸¯ç®¡ç†çµ„åˆ	ä¸‰é‡çœŒ å››æ—¥å¸‚å¸‚ åƒæ­³ç”º	34Â°58â€²	136Â°38â€²
80	é³¥ç¾½	æ°—è±¡åº	ä¸‰é‡çœŒ é³¥ç¾½å¸‚ å …ç¥ç”º	34Â°29â€²	136Â°49â€²
81	å°¾é·²	æ°—è±¡åº	ä¸‰é‡çœŒ å°¾é·²å¸‚ å¤©æº€æµ¦	34Â°5â€²	136Â°12â€²
82	ç†Šé‡	æ°—è±¡åº	ä¸‰é‡çœŒ ç†Šé‡å¸‚ éŠæœ¨ç”º	33Â°56â€²	136Â°10â€²
83	æŸå´	å›½åœŸåœ°ç†é™¢	æ–°æ½ŸçœŒ æŸå´å¸‚ é¯¨æ³¢	37Â°21â€²	138Â°31â€²
84	å°æœ¨	å›½åœŸåœ°ç†é™¢	æ–°æ½ŸçœŒ ä½æ¸¡å¸‚ å°æœ¨ç”º	37Â°49â€²	138Â°17â€²
85	æ–°æ½Ÿæ±æ¸¯	æ¸¯æ¹¾å±€	æ–°æ½ŸçœŒ æ–°æ½Ÿå¸‚ åŒ—åŒº å¤ªéƒä»£	37Â°59â€²	139Â°13â€²
86	ä½æ¸¡	æ°—è±¡åº	æ–°æ½ŸçœŒ ä½æ¸¡å¸‚ é·²å´	38Â°19â€²	138Â°31â€²
87	ä¸Šè¶Šå¸‚ç›´æ±Ÿæ´¥ï¼ˆè‡¨æ™‚ï¼‰	æ°—è±¡åº	æ–°æ½ŸçœŒ ä¸Šè¶Šå¸‚ ç›´æ±Ÿæ´¥	37Â°11â€²	138Â°15â€²
88	ç²Ÿå³¶	æµ·ä¸Šä¿å®‰åº	æ–°æ½ŸçœŒ å²©èˆ¹éƒ¡ ç²Ÿå³¶æµ¦æ‘ å†…æµ¦	38Â°28â€²	139Â°15â€²
89	æ–°æ½Ÿè¥¿æ¸¯	æ¸¯æ¹¾å±€	æ–°æ½ŸçœŒ æ–°æ½Ÿå¸‚ ä¸­å¤®åŒº å…¥èˆ¹ç”º	37Â°56â€²	139Â°4â€²
90	ç”Ÿåœ°	æ°´ç®¡ç†ãƒ»å›½åœŸä¿å…¨å±€	å¯Œå±±çœŒ é»’éƒ¨å¸‚ ç”Ÿåœ°	36Â°53â€²	137Â°25â€²
91	æ–°æ¹Š	æ¸¯æ¹¾å±€	å¯Œå±±çœŒ å°„æ°´å¸‚ å €å²¡æ–°æ˜ç¥	36Â°47â€²	137Â°7â€²
92	å¯Œå±±	æ°—è±¡åº	å¯Œå±±çœŒ å¯Œå±±å¸‚ è‰å³¶	36Â°46â€²	137Â°13â€²
93	ä¼æœ¨å¯Œå±±	æ¸¯æ¹¾å±€	å¯Œå±±çœŒ é«˜å²¡å¸‚ ä¼æœ¨éŒ¦ç”º	36Â°48â€²	137Â°4â€²
94	è¼ªå³¶æ¸¯ï¼ˆè‡¨æ™‚ï¼‰	æ¸¯æ¹¾å±€	çŸ³å·çœŒ è¼ªå³¶å¸‚ æ²³äº•ç”º	37Â°24â€²	136Â°54â€²
95	èƒ½ç™»	æ°—è±¡åº	çŸ³å·çœŒ ç æ´²å¸‚ é•·æ©‹ç”º	37Â°30â€²	137Â°9â€²
96	ç æ´²å¸‚é£¯ç”°ï¼ˆè‡¨æ™‚ï¼‰	æ°—è±¡åº	çŸ³å·çœŒ ç æ´²å¸‚ é£¯ç”°ç”º	37Â°26â€²	137Â°16â€²
97	ä¸ƒå°¾	æ¸¯æ¹¾å±€	çŸ³å·çœŒ ä¸ƒå°¾å¸‚ åºœä¸­ç”º	37Â°3â€²	136Â°58â€²
98	é‡‘æ²¢	æ¸¯æ¹¾å±€	çŸ³å·çœŒ é‡‘æ²¢å¸‚ å¤§é‡ç”ºï¼”ä¸ç›®	36Â°37â€²	136Â°36â€²
99	ä¸‰å›½	å›½åœŸåœ°ç†é™¢	ç¦äº•çœŒ å‚äº•å¸‚ ä¸‰å›½ç”º	36Â°15â€²	136Â°9â€²
100	æ•¦è³€	æ¸¯æ¹¾å±€	ç¦äº•çœŒ æ•¦è³€å¸‚ å·å´ç”ºåœ°å…ˆ	35Â°40â€²	136Â°4â€²
101	èˆé¶´	æ°—è±¡åº	äº¬éƒ½åºœ èˆé¶´å¸‚ æµœ	35Â°29â€²	135Â°23â€²
102	æ·¡è¼ª	æ°—è±¡åº	å¤§é˜ªåºœ æ³‰å—éƒ¡ å²¬ç”º æ·¡è¼ª	34Â°20â€²	135Â°11â€²
103	å¤§é˜ª	æ°—è±¡åº	å¤§é˜ªåºœ å¤§é˜ªå¸‚ æ¸¯åŒº ç¯‰æ¸¯ï¼“ä¸ç›®	34Â°39â€²	135Â°26â€²
104	å§«è·¯ï¼ˆé£¾ç£¨ï¼‰	å…µåº«çœŒ	å…µåº«çœŒ å§«è·¯å¸‚ é£¾ç£¨åŒº é ˆè³€	34Â°47â€²	134Â°40â€²
105	æ´¥å±…å±±	å…µåº«çœŒ	å…µåº«çœŒ è±Šå²¡å¸‚ å°å³¶	35Â°39â€²	134Â°50â€²
106	ç¥æˆ¸	æ°—è±¡åº	å…µåº«çœŒ ç¥æˆ¸å¸‚ ä¸­å¤®åŒº æ³¢æ­¢å ´ç”º	34Â°41â€²	135Â°11â€²
107	æ´²æœ¬	æ°—è±¡åº	å…µåº«çœŒ æ´²æœ¬å¸‚ æµ·å²¸é€šï¼‘ä¸ç›®	34Â°21â€²	134Â°54â€²
108	æµ·å—	å›½åœŸåœ°ç†é™¢	å’Œæ­Œå±±çœŒ æµ·å—å¸‚ å†·æ°´	34Â°9â€²	135Â°12â€²
109	æµ¦ç¥	æ°—è±¡åº	å’Œæ­Œå±±çœŒ æ±ç‰Ÿå©éƒ¡ é‚£æ™ºå‹æµ¦ç”º æµ¦ç¥	33Â°34â€²	135Â°54â€²
110	ä¸²æœ¬	æ°—è±¡åº	å’Œæ­Œå±±çœŒ æ±ç‰Ÿå©éƒ¡ ä¸²æœ¬ç”º ä¸²æœ¬	33Â°29â€²	135Â°46â€²
111	ç™½æµœ	æ°—è±¡åº	å’Œæ­Œå±±çœŒ è¥¿ç‰Ÿå©éƒ¡ ç™½æµœç”º å …ç”°	33Â°41â€²	135Â°23â€²
112	å¾¡åŠ	æ°—è±¡åº	å’Œæ­Œå±±çœŒ å¾¡åŠå¸‚ åç”°ç”º	33Â°51â€²	135Â°10â€²
113	å’Œæ­Œå±±	æ°—è±¡åº	å’Œæ­Œå±±çœŒ å’Œæ­Œå±±å¸‚ æ¹Šé’å²¸	34Â°13â€²	135Â°9â€²
114	ä¸‰èŸ 	æ°´ç®¡ç†ãƒ»å›½åœŸä¿å…¨å±€	å²¡å±±çœŒ å²¡å±±å¸‚ ä¸­åŒº æ–°ç¯‰æ¸¯	34Â°36â€²	133Â°59â€²
115	ä¹™å³¶	æ°´ç®¡ç†ãƒ»å›½åœŸä¿å…¨å±€	å²¡å±±çœŒ å€‰æ•·å¸‚ ç‰å³¶ ä¹™å³¶	34Â°30â€²	133Â°41â€²
116	å®‡é‡	æ°—è±¡åº	å²¡å±±çœŒ ç‰é‡å¸‚ å®‡é‡ï¼‘ä¸ç›®	34Â°29â€²	133Â°57â€²
117	åºƒå³¶	æµ·ä¸Šä¿å®‰åº	åºƒå³¶çœŒ åºƒå³¶å¸‚ å—åŒº å®‡å“æµ·å²¸ï¼’ä¸ç›®	34Â°21â€²	132Â°28â€²
118	å‘‰	æµ·ä¸Šä¿å®‰åº	åºƒå³¶çœŒ å‘‰å¸‚ å®ç”º	34Â°14â€²	132Â°33â€²
119	æµœç”°	æ°—è±¡åº	å³¶æ ¹çœŒ æµœç”°å¸‚ å¤§è¾»ç”º	34Â°54â€²	132Â°4â€²
120	è¥¿éƒ·	æ°—è±¡åº	å³¶æ ¹çœŒ éš å²éƒ¡ éš å²ã®å³¶ç”º æ¸¯ç”º	36Â°12â€²	133Â°20â€²
121	ç”°å¾Œ	å›½åœŸåœ°ç†é™¢	é³¥å–çœŒ å²©ç¾éƒ¡ å²©ç¾ç”º ç”°å¾Œ	35Â°36â€²	134Â°19â€²
122	å¢ƒ	æ°—è±¡åº	é³¥å–çœŒ å¢ƒæ¸¯å¸‚ å¢ƒæ¸¯	35Â°33â€²	133Â°15â€²
123	å°æ¾å³¶	æ°—è±¡åº	å¾³å³¶çœŒ å°æ¾å³¶å¸‚ å°æ¾å³¶ç”º	34Â°1â€²	134Â°35â€²
124	é˜¿æ³¢ç”±å²	æ°—è±¡åº	å¾³å³¶çœŒ æµ·éƒ¨éƒ¡ ç¾æ³¢ç”º è¥¿ç”±å²	33Â°46â€²	134Â°36â€²
125	ä¸å³¶	æ¸¯æ¹¾å±€	é¦™å·çœŒ å‚å‡ºå¸‚ ä¸å³¶ç”º	34Â°23â€²	133Â°49â€²
126	é’æœ¨	æ¸¯æ¹¾å±€	é¦™å·çœŒ ä¸¸äº€å¸‚ åºƒå³¶ç”º	34Â°22â€²	133Â°41â€²
127	å¤šåº¦æ´¥	æ¸¯æ¹¾å±€	é¦™å·çœŒ ä»²å¤šåº¦éƒ¡ å¤šåº¦æ´¥ç”º æ±æµœ	34Â°17â€²	133Â°45â€²
128	é«˜æ¾	æ°—è±¡åº	é¦™å·çœŒ é«˜æ¾å¸‚ åŒ—æµœç”º	34Â°21â€²	134Â°3â€²
129	æ¥å³¶èˆªè·¯	æ¸¯æ¹¾å±€	æ„›åª›çœŒ ä»Šæ²»å¸‚ é¦¬å³¶	34Â°7â€²	132Â°59â€²
130	æ¾å±±	æ°—è±¡åº	æ„›åª›çœŒ æ¾å±±å¸‚ æµ·å²¸é€š	33Â°52â€²	132Â°43â€²
131	å®‡å’Œå³¶	æ°—è±¡åº	æ„›åª›çœŒ å®‡å’Œå³¶å¸‚ ä½å‰ï¼“ä¸ç›®	33Â°14â€²	132Â°33â€²
132	ä¹…ç¤¼	å›½åœŸåœ°ç†é™¢	é«˜çŸ¥çœŒ é«˜å²¡éƒ¡ ä¸­åœŸä½ç”º ä¹…ç¤¼	33Â°20â€²	133Â°15â€²
133	å®¤æˆ¸å²¬	æ°—è±¡åº	é«˜çŸ¥çœŒ å®¤æˆ¸å¸‚ å®¤æˆ¸å²¬ç”º	33Â°16â€²	134Â°10â€²
134	é«˜çŸ¥	æ°—è±¡åº	é«˜çŸ¥çœŒ é«˜çŸ¥å¸‚ æµ¦æˆ¸	33Â°30â€²	133Â°34â€²
135	åœŸä½æ¸…æ°´	æ°—è±¡åº	é«˜çŸ¥çœŒ åœŸä½æ¸…æ°´å¸‚ æ—­ç”ºï¼“ä¸ç›®	32Â°47â€²	132Â°58â€²
136	é•·åºœ	æ¸¯æ¹¾å±€	å±±å£çœŒ ä¸‹é–¢å¸‚ é•·åºœç”º	34Â°1â€²	131Â°0â€²
137	é ˆä½	å›½åœŸåœ°ç†é™¢	å±±å£çœŒ è©å¸‚ ç“¦æµ´	34Â°38â€²	131Â°36â€²
138	ç”°ãƒé¦–	æ¸¯æ¹¾å±€	å±±å£çœŒ ä¸‹é–¢å¸‚ å½¦å³¶ç”°ã®é¦–ç”ºï¼‘ä¸ç›®	33Â°55â€²	130Â°55â€²
139	å¤§å±±ã®é¼»	æ¸¯æ¹¾å±€	å±±å£çœŒ ä¸‹é–¢å¸‚ å½¦å³¶å¡©æµœç”ºï¼”ä¸ç›®	33Â°55â€²	130Â°54â€²
140	å—é¢¨æ³Š	æ¸¯æ¹¾å±€	å±±å£çœŒ ä¸‹é–¢å¸‚ å½¦å³¶è¥¿å±±ç”ºï¼“ä¸ç›®	33Â°57â€²	130Â°53â€²
141	å®‡éƒ¨	æ¸¯æ¹¾å±€	å±±å£çœŒ å®‡éƒ¨å¸‚ æ²–å®‡éƒ¨	33Â°56â€²	131Â°15â€²
142	å¾³å±±	æµ·ä¸Šä¿å®‰åº	å±±å£çœŒ å‘¨å—å¸‚ é‚£æ™ºç”º	34Â°2â€²	131Â°48â€²
143	å¼Ÿå­å¾…	æ¸¯æ¹¾å±€	å±±å£çœŒ ä¸‹é–¢å¸‚ å½¦å³¶å¼Ÿå­å¾…ç”ºï¼’ä¸ç›®	33Â°56â€²	130Â°56â€²
144	è‹…ç”°	æ¸¯æ¹¾å±€	ç¦å²¡çœŒ äº¬éƒ½éƒ¡ è‹…ç”°ç”º æ¸¯ç”º	33Â°48â€²	131Â°0â€²
145	æ—¥æ˜	æ¸¯æ¹¾å±€	ç¦å²¡çœŒ åŒ—ä¹å·å¸‚ å°å€‰åŒ—åŒº è¥¿æ¸¯ç”º	33Â°55â€²	130Â°53â€²
146	é’æµœ	æ¸¯æ¹¾å±€	ç¦å²¡çœŒ åŒ—ä¹å·å¸‚ é–€å¸åŒº ç™½é‡æ±Ÿ	33Â°57â€²	131Â°1â€²
147	é–€å¸	æ¸¯æ¹¾å±€	ç¦å²¡çœŒ åŒ—ä¹å·å¸‚ é–€å¸åŒº è¥¿æµ·å²¸é€šï¼‘ä¸ç›®	33Â°57â€²	130Â°57â€²
148	ç ‚æ´¥	æ¸¯æ¹¾å±€	ç¦å²¡çœŒ åŒ—ä¹å·å¸‚ å°å€‰åŒ—åŒº æµ…é‡ï¼“ä¸ç›®	33Â°54â€²	130Â°53â€²
149	åšå¤š	æµ·ä¸Šä¿å®‰åº	ç¦å²¡çœŒ ç¦å²¡å¸‚ æ±åŒº æ±æµœï¼’ä¸ç›®	33Â°37â€²	130Â°24â€²
150	ä½ä¼¯	æ°—è±¡åº	å¤§åˆ†çœŒ ä½ä¼¯å¸‚ é¶´è¦‹	32Â°57â€²	131Â°58â€²
151	å¤§åˆ†	æµ·ä¸Šä¿å®‰åº	å¤§åˆ†çœŒ å¤§åˆ†å¸‚ ä¸‰ä½	33Â°16â€²	131Â°41â€²
152	åˆ¥åºœ	æ¸¯æ¹¾å±€	å¤§åˆ†çœŒ åˆ¥åºœå¸‚ å—çŸ³å£	33Â°18â€²	131Â°30â€²
153	çš‡å	æ¸¯æ¹¾å±€	é•·å´çœŒ é•·å´å¸‚ å°ç€¬æˆ¸ç”º	32Â°43â€²	129Â°50â€²
154	å£ä¹‹æ´¥	æ°—è±¡åº	é•·å´çœŒ å—å³¶åŸå¸‚ å£ä¹‹æ´¥ç”º	32Â°36â€²	130Â°12â€²
155	é•·å´	æ°—è±¡åº	é•·å´çœŒ é•·å´å¸‚ æ¾ãŒæç”º	32Â°44â€²	129Â°52â€²
156	ç¦æ±Ÿ	æ°—è±¡åº	é•·å´çœŒ äº”å³¶å¸‚ æ±æµœç”º	32Â°42â€²	128Â°51â€²
157	å¯¾é¦¬æ¯”ç”°å‹	æ°—è±¡åº	é•·å´çœŒ å¯¾é¦¬å¸‚ ä¸Šå¯¾é¦¬ç”º	34Â°39â€²	129Â°29â€²
158	ä½ä¸–ä¿	æµ·ä¸Šä¿å®‰åº	é•·å´çœŒ ä½ä¸–ä¿å¸‚ å¹²å°½ç”º	33Â°9â€²	129Â°43â€²
159	å³åŸ	æµ·ä¸Šä¿å®‰åº	é•·å´çœŒ å¯¾é¦¬å¸‚ å³åŸç”º	34Â°12â€²	129Â°18â€²
160	å¹³æˆ¸ç€¬æˆ¸	æ¸¯æ¹¾å±€	é•·å´çœŒ å¹³æˆ¸å¸‚ ç”°å¹³ç”º	33Â°22â€²	129Â°35â€²
161	éƒ·ãƒæµ¦	æ¸¯æ¹¾å±€	é•·å´çœŒ å£±å²å¸‚ éƒ·ãƒæµ¦ç”º	33Â°45â€²	129Â°41â€²
162	å”æ´¥	æ¸¯æ¹¾å±€	ä½è³€çœŒ å”æ´¥å¸‚ äºŒå¤•å­	33Â°28â€²	129Â°58â€²
163	ä»®å±‹	å›½åœŸåœ°ç†é™¢	ä½è³€çœŒ æ±æ¾æµ¦éƒ¡ ç„æµ·ç”º ä»®å±‹	33Â°28â€²	129Â°51â€²
164	å¤§æµ¦	æ°—è±¡åº	ä½è³€çœŒ è—¤æ´¥éƒ¡ å¤ªè‰¯ç”º å¤§æµ¦	32Â°59â€²	130Â°13â€²
165	å…«ä»£	æ¸¯æ¹¾å±€	ç†Šæœ¬çœŒ å…«ä»£å¸‚ æ¸¯ç”º	32Â°31â€²	130Â°34â€²
166	ç†Šæœ¬	æ¸¯æ¹¾å±€	ç†Šæœ¬çœŒ ç†Šæœ¬å¸‚ è¥¿åŒº æ²–æ–°ç”º	32Â°45â€²	130Â°34â€²
167	æœ¬æ¸¡ç€¬æˆ¸	æ¸¯æ¹¾å±€	ç†Šæœ¬çœŒ å¤©è‰å¸‚ å¤§é–€	32Â°26â€²	130Â°13â€²
168	è‹“åŒ—	æ°—è±¡åº	ç†Šæœ¬çœŒ å¤©è‰éƒ¡ è‹“åŒ—ç”º éƒ½å‘‚ã€…	32Â°28â€²	130Â°2â€²
169	å®®å´	æ¸¯æ¹¾å±€	å®®å´çœŒ å®®å´å¸‚ æ¸¯ï¼‘ä¸ç›®	31Â°54â€²	131Â°27â€²
170	ç´°å³¶	å›½åœŸåœ°ç†é™¢	å®®å´çœŒ æ—¥å‘å¸‚ ç´°å³¶ç”º	32Â°26â€²	131Â°40â€²
171	æ²¹æ´¥	æ°—è±¡åº	å®®å´çœŒ æ—¥å—å¸‚ å¤§ç¯€	31Â°35â€²	131Â°25â€²
172	é˜¿ä¹…æ ¹	å›½åœŸåœ°ç†é™¢	é¹¿å…å³¶çœŒ é˜¿ä¹…æ ¹å¸‚ æ³¢ç•™	32Â°1â€²	130Â°11â€²
173	é¹¿å…å³¶	æ°—è±¡åº	é¹¿å…å³¶çœŒ é¹¿å…å³¶å¸‚ æœ¬æ¸¯æ–°ç”º	31Â°36â€²	130Â°34â€²
174	æ•å´	æ°—è±¡åº	é¹¿å…å³¶çœŒ æ•å´å¸‚ æ¾ä¹‹å°¾ç”º	31Â°16â€²	130Â°18â€²
175	ç¨®å­å³¶	æ°—è±¡åº	é¹¿å…å³¶çœŒ ç†Šæ¯›éƒ¡ ä¸­ç¨®å­ç”º å‚äº•	30Â°28â€²	130Â°58â€²
176	å¥„ç¾	æ°—è±¡åº	é¹¿å…å³¶çœŒ å¥„ç¾å¸‚ åç€¬å°æ¹Š	28Â°19â€²	129Â°32â€²
177	å¤§æ³Š	æµ·ä¸Šä¿å®‰åº	é¹¿å…å³¶çœŒ è‚å±éƒ¡ å—å¤§éš…ç”º ä½å¤šé¦¬ç± 	31Â°1â€²	130Â°41â€²
178	è¥¿ä¹‹è¡¨	æµ·ä¸Šä¿å®‰åº	é¹¿å…å³¶çœŒ è¥¿ä¹‹è¡¨å¸‚ è¥¿ä¹‹è¡¨	30Â°44â€²	131Â°0â€²
179	ä¸­ä¹‹å³¶	æµ·ä¸Šä¿å®‰åº	é¹¿å…å³¶çœŒ é¹¿å…å³¶éƒ¡ åå³¶æ‘ ä¸­ä¹‹å³¶	29Â°51â€²	129Â°51â€²
180	åç€¬	æµ·ä¸Šä¿å®‰åº	é¹¿å…å³¶çœŒ å¥„ç¾å¸‚ åç€¬é•·æµœç”º	28Â°24â€²	129Â°30â€²
181	å¿—å¸ƒå¿—	æ¸¯æ¹¾å±€	é¹¿å…å³¶çœŒ å¿—å¸ƒå¿—å¸‚ å¿—å¸ƒå¿—ç”º	31Â°29â€²	131Â°7â€²
182	æ²–ç¸„	å›½åœŸåœ°ç†é™¢	æ²–ç¸„çœŒ å—åŸå¸‚ çŸ¥å¿µ	26Â°11â€²	127Â°49â€²
183	é‚£è¦‡	æ°—è±¡åº	æ²–ç¸„çœŒ é‚£è¦‡å¸‚ é€šå ‚ç”º	26Â°13â€²	127Â°40â€²
184	ä¸­åŸæ¹¾æ¸¯	æ¸¯æ¹¾å±€	æ²–ç¸„çœŒ æ²–ç¸„å¸‚ æµ·é‚¦	26Â°20â€²	127Â°50â€²
185	å—å¤§æ±	æ°—è±¡åº	æ²–ç¸„çœŒ å³¶å°»éƒ¡ å—å¤§æ±æ‘ åŒ—	25Â°52â€²	131Â°14â€²
186	å¹³è‰¯	æ¸¯æ¹¾å±€	æ²–ç¸„çœŒ å®®å¤å³¶å¸‚ å¹³è‰¯è¥¿é‡Œ	24Â°49â€²	125Â°17â€²
187	çŸ³å£	æ°—è±¡åº	æ²–ç¸„çœŒ çŸ³å£å¸‚ å…«å³¶ç”ºï¼’ä¸ç›®	24Â°20â€²	124Â°10â€²
188	ä¸é‚£å›½	æ°—è±¡åº	æ²–ç¸„çœŒ å…«é‡å±±éƒ¡ ä¸é‚£å›½ç”º ä¹…éƒ¨è‰¯	24Â°27â€²	122Â°57â€²
`;

// SVG Icons
function getTideSvg(type) {
    const s = 'stroke="black" stroke-width="2"';
    if(type=='jma') return `<svg viewBox="0 0 20 20"><circle cx="10" cy="10" r="7" fill="#ffff00" ${s}/></svg>`;
    if(type=='jcg') return `<svg viewBox="0 0 20 20"><polygon points="2,2 18,2 10,18" fill="#00ffff" ${s}/></svg>`;
    if(type=='gsi') return `<svg viewBox="0 0 20 20"><rect x="3" y="3" width="14" height="14" fill="#00ff00" ${s}/></svg>`;
    if(type=='port') return `<svg viewBox="0 0 20 20"><polygon points="10,2 18,10 10,18 2,10" fill="#ff0000" ${s}/></svg>`;
    if(type=='riv') return `<svg viewBox="0 0 20 20"><polygon points="10,2 18,18 2,18" fill="#d3d3d3" ${s}/></svg>`;
    return `<svg viewBox="0 0 20 20"><polygon points="10,1 12,7 19,7 13,11 15,18 10,14 5,18 7,11 1,7 8,7" fill="#0000ff" ${s}/></svg>`;
}

// --- Initialization ---
window.onload = async () => {
    initMap();
    initResizer();
    await loadExternalStations();
    connectWebSocket();
    fetchHistory(0);
    loadGeoJSON();
    setInterval(() => { document.getElementById("clock").textContent = new Date().toLocaleTimeString('ja-JP'); }, 1000);

    // Sidebar & GPS Bindings
    document.getElementById("btn-menu-toggle").onclick = toggleSidebar;
    document.getElementById("btn-pin-sidebar").onclick = toggleSidebarPin;
    document.getElementById("btn-gps-main").onclick = flyToCurrentLocation;

    // Existing Bindings
    document.getElementById("btn-audio").onclick = toggleAudio;
    document.getElementById("btn-auto-zoom").onclick = toggleAutoZoom;
    document.getElementById("btn-list-zoom").onclick = toggleListClickZoom;
    document.getElementById("btn-points-toggle").onclick = togglePoints;
    document.getElementById("btn-load-more").onclick = () => { fetchOffset += 20; fetchHistory(fetchOffset); };
    document.getElementById("btn-settings").onclick = openSettings;
    document.getElementById("modal-close").onclick = cancelSettings;
    document.getElementById("btn-cancel-settings").onclick = cancelSettings;
    document.getElementById("btn-save-settings").onclick = saveSettings;
    document.getElementById("btn-screenshot").onclick = takeScreenshot;
    document.getElementById("btn-tide-toggle").onclick = toggleTide;
    document.getElementById("filter-min-shindo").onchange = rebuildList;
    document.getElementById("header-loc-select").onchange = (e) => { if(e.target.value !== "") jumpToLocation(e.target.value); };
// Help Modal Bindings
    document.getElementById("btn-help").onclick = () => {
        document.getElementById("help-modal-overlay").style.display = "block";
    };
    document.getElementById("help-modal-close").onclick = () => {
        document.getElementById("help-modal-overlay").style.display = "none";
    };
    // Overlay click to close
    document.getElementById("help-modal-overlay").onclick = (e) => {
        if(e.target.id === "help-modal-overlay") {
            document.getElementById("help-modal-overlay").style.display = "none";
        }
    };

    ['jma','jcg','gsi','port','riv','pref'].forEach(k => { document.getElementById(`leg-${k}`).innerHTML = getTideSvg(k); });

    initDraggableModal();
    animationLoop();
    updateUserMarkersAndDropdown();
    
    // Tool Panel Hover
    const toolContainer = document.getElementById("map-tool-container");
    const toolBtn = document.getElementById("tool-toggle-btn");
    const toolPanel = document.getElementById("tool-panel-content");
    
    toolContainer.addEventListener('mouseenter', () => { if(!isToolLocked) toolPanel.style.display = 'flex'; });
    toolContainer.addEventListener('mouseleave', () => { if(!isToolLocked) toolPanel.style.display = 'none'; });
    toolBtn.addEventListener('click', () => {
        isToolLocked = !isToolLocked;
        if(isToolLocked) {
            toolBtn.classList.add('pinned');
            toolBtn.innerHTML = "ğŸ“Œ ãƒ„ãƒ¼ãƒ« (å›ºå®š)";
            toolPanel.style.display = 'flex';
        } else {
            toolBtn.classList.remove('pinned');
            toolBtn.innerHTML = "ğŸ› ï¸ è¡¨ç¤ºãƒ»ãƒ„ãƒ¼ãƒ«";
            if(!toolContainer.matches(':hover')) toolPanel.style.display = 'none';
        }
    });
};

// --- Sidebar Logic ---
function toggleSidebar() {
    isSidebarVisible = !isSidebarVisible;
    const sidebar = document.getElementById("quake-list-area");
    const container = document.getElementById("app-container");
    
    if (isSidebarVisible) {
        sidebar.classList.add('visible');
        if(isSidebarPinned) {
            container.classList.add('pinned');
        }
    } else {
        sidebar.classList.remove('visible');
        container.classList.remove('pinned');
    }
}

function toggleSidebarPin() {
    isSidebarPinned = !isSidebarPinned;
    const btn = document.getElementById("btn-pin-sidebar");
    const container = document.getElementById("app-container");
    
    if (isSidebarPinned) {
        btn.classList.add("active");
        btn.innerHTML = "ğŸ“Œ ãƒ”ãƒ³ç•™ã‚ä¸­";
        if (isSidebarVisible) container.classList.add("pinned");
    } else {
        btn.classList.remove("active");
        btn.innerHTML = "ğŸ“Œ ãƒ”ãƒ³ç•™ã‚";
        container.classList.remove("pinned");
        // ãƒ”ãƒ³ç•™ã‚è§£é™¤æ™‚ã¯ã€Œé–‰ã˜ã‚‹ã€ã®ã§ã¯ãªãã€Œã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤è¡¨ç¤ºã€ã«åˆ‡ã‚Šæ›¿ã‚ã‚‹ãŒã€
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œéš ã‚Œã¦ã»ã—ã„ã€ã¨æ„Ÿã˜ã‚‹å ´åˆã€æ‰‹å‹•ã§é–‰ã˜ã¦ã‚‚ã‚‰ã†ã‹ã€
        // ã‚ã‚‹ã„ã¯åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹ã€‚
    }
    setTimeout(() => map.invalidateSize(), 300);
}

// --- GPS Logic ---
function flyToCurrentLocation() {
    if (!navigator.geolocation) { alert("ãŠä½¿ã„ã®ç«¯æœ«ã¯GPSã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚"); return; }
    const btn = document.getElementById("btn-gps-main");
    btn.style.background = "#e3f2fd";
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            map.flyTo([lat, lon], 12);
            // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼
            L.circleMarker([lat, lon], { radius: 8, color: '#2196F3', fillColor: '#2196F3', fillOpacity: 0.3 })
             .addTo(map).bindPopup("ç¾åœ¨åœ°").openPopup();
             L.circleMarker([lat, lon], { radius: 3, color: '#fff', fillColor: '#2196F3', fillOpacity: 1 }).addTo(map);
             btn.style.background = "#fff";
        },
        (err) => {
            alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\næ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            btn.style.background = "#fff";
        },
        { timeout: 10000 }
    );
}

// --- Other Logic (Existing) ---
async function loadExternalStations() {
    const statusDiv = document.getElementById("station-status");
    try {
        const response = await fetch("https://raw.githubusercontent.com/iku55/jma_int_stations/main/stations.json");
        if (!response.ok) throw new Error("err");
        const data = await response.json();
        data.forEach(item => { if (item.name && item.lat) STATION_LOCATIONS[item.name] = { lat: parseFloat(item.lat), lon: parseFloat(item.lon) }; });
        statusDiv.textContent = `è¦³æ¸¬ç‚¹: ${Object.keys(STATION_LOCATIONS).length}`;
    } catch (e) { statusDiv.textContent = "Data Error"; }
}

function initMap() {
    const cartoDark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO', maxZoom: 19 });
    const gsiStd = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', { attribution: '&copy; å›½åœŸåœ°ç†é™¢', maxZoom: 18 });
    const gsiPale = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/pale/{z}/{x}/{y}.png', { attribution: '&copy; å›½åœŸåœ°ç†é™¢', maxZoom: 18 });
    const gsiPhoto = L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/seamlessphoto/{z}/{x}/{y}.jpg', { attribution: '&copy; å›½åœŸåœ°ç†é™¢', maxZoom: 18 });
    
    map = L.map('map', { zoomControl: false, preferCanvas: true, layers: [cartoDark] }).setView([36.5, 138], 5);
    
    L.control.layers({
        "ãƒ€ãƒ¼ã‚¯ (è‹±å­—)": cartoDark,
        "æ¨™æº– (æ—¥æœ¬èª)": gsiStd,
        "æ·¡è‰² (æ—¥æœ¬èª)": gsiPale,
        "èˆªç©ºå†™çœŸ": gsiPhoto
    }, null, { position: 'topright' }).addTo(map);

    L.control.zoom({ position: 'bottomright' }).addTo(map);

    tsunamiLayerGroup = L.layerGroup().addTo(map);
    tideLayerGroup = L.layerGroup().addTo(map);
    pWaveLayer = L.circle([0,0], { radius: 0, color: '#2196F3', weight: 1, fill: false, opacity: 0 }).addTo(map);
    sWaveLayer = L.circle([0,0], { radius: 0, color: '#f44336', weight: 2, fill: false, opacity: 0 }).addTo(map);
    pointsLayerGroup = L.layerGroup().addTo(map);

    map.on('click', (e) => {
        if(isPickingLocation) {
            document.getElementById("new-loc-lat").value = e.latlng.lat.toFixed(4);
            document.getElementById("new-loc-lon").value = e.latlng.lng.toFixed(4);
            isPickingLocation = false;
            document.getElementById("map").classList.remove("crosshair-cursor");
            document.getElementById("modal-overlay").style.display = "block"; 
        } else {
            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒãƒ”ãƒ³ç•™ã‚ã•ã‚Œã¦ãŠã‚‰ãšã€ã‹ã¤è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã€åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
            if(!isSidebarPinned && isSidebarVisible) {
                toggleSidebar();
            }
        }
    });
}

function connectWebSocket() {
    if(socket) socket.close();
    socket = new WebSocket(WS_URL);
    socket.onopen = () => document.getElementById("conn-status").className = "status-dot status-connected";
    socket.onmessage = (e) => {
        try {
            const data = JSON.parse(e.data);
            if(data.code===551) {
                if(!quakeData.find(q=>q.id===data.id)) {
                    quakeData.unshift(data);
                    if(quakeData.length > 200) quakeData.pop();
                    rebuildList();
                    const minShindo = parseInt(document.getElementById("filter-min-shindo").value) || 0;
                    if(data.earthquake.maxScale >= minShindo) {
                        selectQuake(data.id, 'auto');
                        speak(`éœ‡åº¦${formatShindo(data.earthquake.maxScale).text}ã€${data.earthquake.hypocenter.name}`);
                    }
                }
            }
            if(data.code===554||data.code===556) handleEEW(data);
            if(data.code===552) handleTsunami(data);
        } catch(err){}
    };
    socket.onclose = () => { document.getElementById("conn-status").className = "status-dot status-error"; setTimeout(connectWebSocket, 5000); };
}

async function fetchHistory(offset) {
    const btn = document.getElementById("btn-load-more"); btn.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
    try {
        const res = await fetch(`${HISTORY_API}&limit=20&offset=${offset}`);
        const newDetail = await res.json();
        const cleanNew = newDetail.filter(item => !quakeData.find(q => q.id === item.id));
        if(cleanNew.length > 0) {
            quakeData = quakeData.concat(cleanNew).sort((a,b) => new Date(b.earthquake.time) - new Date(a.earthquake.time));
            rebuildList();
            if(offset===0 && cleanNew.length > 0) selectQuake(cleanNew[0].id, 'auto');
        }
        btn.textContent = "ã•ã‚‰ã«èª­ã¿è¾¼ã‚€";
    } catch(e) { btn.textContent = "å–å¾—å¤±æ•—"; }
}

function rebuildList() {
    const container = document.getElementById("list-container"); container.innerHTML = "";
    const minShindo = parseInt(document.getElementById("filter-min-shindo").value) || 0;
    const visibleData = quakeData.filter(d => d.code === 551 && d.earthquake.maxScale >= minShindo);
    
    // æ—¥ä»˜ã”ã¨ã®ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    const groups = {}; const dates = [];
    visibleData.forEach(d => {
        const dateStr = d.earthquake.time.split(' ')[0];
        if(!groups[dateStr]) { groups[dateStr] = []; dates.push(dateStr); }
        groups[dateStr].push(d);
    });

    const visibleIds = visibleData.map(d => d.id);
    Object.keys(markers).forEach(id => { if(!visibleIds.includes(id)) { map.removeLayer(markers[id]); delete markers[id]; } });

    dates.forEach((date, idx) => {
        const details = document.createElement("details"); details.className = "quake-group";
        if(idx === 0) details.open = true;
        const summary = document.createElement("summary");
        summary.innerHTML = `<span>ğŸ“… ${date}</span> <span>${groups[date].length}ä»¶</span>`;
        details.appendChild(summary);
        groups[date].forEach(data => {
            details.appendChild(createQuakeItem(data));
            createMarker(data);
        });
        container.appendChild(details);
    });
}

function createQuakeItem(data) {
    const q = data.earthquake; const s = formatShindo(q.maxScale);
    const item = document.createElement("div"); item.className = "quake-item"; item.id = `list-${data.id}`;
    item.innerHTML = `<div class="intensity-box" style="background:${s.color};">${s.text}</div><div class="quake-info"><span class="quake-place">${q.hypocenter.name}</span><span class="quake-time">${q.time.split(' ')[1]}</span></div>`;
    item.onclick = () => selectQuake(data.id, 'list');
    return item;
}

function createMarker(data) {
    if (data.earthquake.hypocenter.latitude != -200 && !markers[data.id]) {
        const s = formatShindo(data.earthquake.maxScale);
        const m = L.circleMarker([data.earthquake.hypocenter.latitude, data.earthquake.hypocenter.longitude], {
            radius: config.markerBaseSize + (Math.sqrt(data.earthquake.maxScale-10)*1.5), 
            color: '#fff', weight: 1, fillColor: s.color, fillOpacity: 0.8
        }).addTo(map);
        m.on('click', () => selectQuake(data.id, 'map'));
        markers[data.id] = m;
    }
}

function selectQuake(id, source) {
    const data = quakeData.find(q=>q.id===id); if(!data) return;
    document.querySelectorAll('.quake-item').forEach(el => el.classList.remove('active'));
    document.getElementById(`list-${id}`)?.classList.add('active');
    
    updatePanel(data);
    if(markers[id]) {
        Object.values(markers).forEach(m => m.setStyle({weight:1, color:'#fff'}));
        markers[id].setStyle({weight:3, color:'#00ffff'}).bringToFront();
        if((source==='auto' && isAutoZoom) || ((source==='list' || source==='map') && isListClickZoom)) {
            map.flyTo(markers[id].getLatLng(), 7);
        }
    }
    renderObservationPoints(data);
    startWaveAnimation(data);

    // ãƒ¢ãƒã‚¤ãƒ«ã§ãƒªã‚¹ãƒˆé¸æŠæ™‚ã¯ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
    if(source === 'list' && !isSidebarPinned && isSidebarVisible) {
        toggleSidebar();
    }
}

function updatePanel(d){ 
    const q = d.earthquake; const s = formatShindo(q.maxScale);
    document.getElementById("p-time").innerText = q.time.substring(0, 16);
    document.getElementById("p-place").innerText = q.hypocenter.name;
    document.getElementById("p-mag").innerText = "M " + ((q.hypocenter.magnitude!=-1)?q.hypocenter.magnitude:"-"); 
    document.getElementById("p-depth").innerText = "æ·±ã• " + ((q.hypocenter.depth!=-1)?q.hypocenter.depth+"km":"-");
    document.getElementById("p-shindo-box").innerText = s.text; 
    document.getElementById("p-shindo-box").style.background = s.color; 
    document.getElementById("p-shindo-text").innerText = s.fullText;
}

function renderObservationPoints(d){
    pointsLayerGroup.clearLayers();
    if(!isPointsVisible||!d.points)return;
    d.points.forEach(p=>{
        let coord = STATION_LOCATIONS[p.addr];
        if(!coord) {
             const key = Object.keys(STATION_LOCATIONS).find(k => p.addr.includes(k) || k.includes(p.addr));
             if(key) coord = STATION_LOCATIONS[key];
        }
        if(coord) {
            L.circleMarker([coord.lat, coord.lon], { radius: 4, color: '#fff', weight: 1, fillColor: formatShindo(p.scale).color, fillOpacity: 1 })
            .bindTooltip(`${p.addr} : éœ‡åº¦${formatShindo(p.scale).text}`).addTo(pointsLayerGroup);
        }
    });
}

// Utils
function getTimestampFilename(p, e) { const n=new Date(); return `${p}_${n.toISOString().slice(0,10).replace(/-/g,"")}${n.getHours()}${n.getMinutes()}.${e}`; }
async function takeScreenshot() {
    const btn=document.getElementById("btn-screenshot"); btn.innerHTML="â³";
    try {
        const c = await html2canvas(document.getElementById("app-container"), {useCORS:true, allowTaint:false});
        const l = document.createElement('a'); l.download = getTimestampFilename("J-Quake","png"); l.href = c.toDataURL(); l.click();
    } catch(e){}
    btn.innerHTML="ğŸ“· ä¿å­˜";
}

function exportConfig() {
    const dl = document.createElement('a'); dl.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config));
    dl.download = getTimestampFilename("config", "json"); dl.click();
}
function importConfig(input) {
    const f=input.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=e=>{ try{ config=JSON.parse(e.target.result); saveSettings(); location.reload(); }catch(x){alert("Error");}};
    r.readAsText(f);
}

function handleTsunami(data){
    tsunamiLayerGroup.clearLayers();
    const p=document.getElementById("tsunami-panel");
    if(data.cancelled||!data.areas||!data.areas.length){ p.style.display="none"; return;}
    p.style.display="block";
    let maxGrade = 0; const grades={MajorWarning:3, Warning:2, Watch:1, Unknown:0};
    data.areas.forEach(a=>{ if(grades[a.grade]>maxGrade) maxGrade=grades[a.grade]; });
    const msgs = {3:"å¤§æ´¥æ³¢è­¦å ±", 2:"æ´¥æ³¢è­¦å ±", 1:"æ´¥æ³¢æ³¨æ„å ±"};
    document.getElementById("tsunami-content").innerHTML = `<span style="font-size:1.3rem; font-weight:bold; color:${maxGrade==3?'#aa00aa':maxGrade==2?'#ff2800':'#f2e700'}">${msgs[maxGrade]||"ä¸æ˜"}</span> ãŒç™ºè¡¨ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
    if(geoJsonData){
         L.geoJSON(geoJsonData, {
            style: f => {
                const name = f.properties.nam_ja || "";
                const area = data.areas.find(a => name.includes(a.name));
                if(area) {
                    const c = area.grade=="MajorWarning"?"#aa00aa":area.grade=="Warning"?"#ff2800":"#f2e700";
                    return {color:c, weight:2, opacity:1, fillOpacity:0.5, fillColor:c};
                }
                return {opacity:0, fillOpacity:0};
            }
        }).addTo(tsunamiLayerGroup);
    }
}
function clearTsunamiData() { tsunamiLayerGroup.clearLayers(); document.getElementById("tsunami-panel").style.display = "none"; }
async function loadGeoJSON() { try{const r=await fetch(JAPAN_GEOJSON_URL); geoJsonData=await r.json();}catch(e){} }

function handleEEW(data){ showEEWOverlay(data); if(data.code===556 && !data.cancelled) checkPersonalAlert(data); }
function checkPersonalAlert(data){
    const eq=data.earthquake; if(!eq) return;
    let maxScale=-1, targetLoc=null, targetDist=0;
    config.savedLocations.forEach(loc=>{
        const d=getDistance(loc.lat,loc.lon,eq.hypocenter.latitude,eq.hypocenter.longitude);
        const s=predictIntensity(eq.magnitude, d, parseInt(eq.hypocenter.depth));
        if(s>maxScale){ maxScale=s; targetLoc=loc; targetDist=d;}
    });
    if(targetLoc && maxScale>=config.alertThreshold) triggerPersonalAlert(Date.now()+(targetDist/config.sWaveSpeed)*1000, maxScale, targetLoc.name);
}
function triggerPersonalAlert(arrTime, scale, name){
    document.getElementById("personal-alert").style.display="block";
    document.getElementById("alert-location-name").textContent = name;
    document.getElementById("alert-est-shindo").textContent = "äºˆæ¸¬ "+formatShindo(scale).fullText;
    speak(`ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã€‚${name}ã€äºˆæ¸¬éœ‡åº¦${formatShindo(scale).text}`);
    if(alertTimerInterval) clearInterval(alertTimerInterval);
    alertTimerInterval=setInterval(()=>{
        const left=(arrTime-Date.now())/1000;
        document.getElementById("alert-countdown").textContent = left<=0?"åˆ°é”":left.toFixed(1);
        if(left<-60) stopAlert();
    },100);
}
function showEEWOverlay(data){
    const el=document.getElementById("eew-overlay"); el.style.display="block";
    if(data.cancelled){el.innerText="ã‚­ãƒ£ãƒ³ã‚»ãƒ«"; setTimeout(()=>el.style.display="none",3000); return;}
    document.getElementById("eew-text").innerText = data.earthquake ? `${data.earthquake.hypocenter.name} M${data.earthquake.magnitude} æœ€å¤§${formatShindo(data.earthquake.maxScale).text}` : "è©³ç´°è§£æä¸­";
    setTimeout(()=>el.style.display="none", 60000);
}
function stopAlert(){ document.getElementById("personal-alert").style.display="none"; clearInterval(alertTimerInterval); }

function getDistance(lat1,lon1,lat2,lon2){ const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); }
function predictIntensity(m,d,depth){ if(m<1)return 0; const x=Math.max(Math.sqrt(d**2+depth**2),3); const pgv=Math.pow(10,0.58*m-Math.log10(x)-0.002*x-0.6)*2.0; let i=2.68+1.94*Math.log10(pgv); return i<2.5?20:i<3.5?30:i<4.5?40:i<5.0?45:i<5.5?50:i<6.0?55:60; }
function formatShindo(s){ const c=config.colors; const t={10:"1",20:"2",30:"3",40:"4",45:"5-",50:"5+",55:"6-",60:"6+",70:"7"}; const f={10:"éœ‡åº¦1",20:"éœ‡åº¦2",30:"éœ‡åº¦3",40:"éœ‡åº¦4",45:"5å¼±",50:"5å¼·",55:"6å¼±",60:"6å¼·",70:"éœ‡åº¦7"}; return {color:c[s]||"#777", text:t[s]||"?", fullText:f[s]||"ä¸æ˜"}; }

function startWaveAnimation(d){ const t=new Date(d.earthquake.time).getTime(); if((Date.now()-t)/1000>300){currentWaveTarget=null; return;} currentWaveTarget={lat:d.earthquake.hypocenter.latitude, lng:d.earthquake.hypocenter.longitude, time:t}; }
function animationLoop(){
    if(currentWaveTarget){
        const e=(Date.now()-currentWaveTarget.time)/1000;
        if(e>0){pWaveLayer.setLatLng([currentWaveTarget.lat,currentWaveTarget.lng]).setRadius(e*6.5*1000).setStyle({opacity:1}); sWaveLayer.setLatLng([currentWaveTarget.lat,currentWaveTarget.lng]).setRadius(e*config.sWaveSpeed*1000).setStyle({opacity:1});}
    }
    requestAnimationFrame(animationLoop);
}

function toggleAudio(){ isAudioOn=!isAudioOn; updateBtn("btn-audio", isAudioOn, "ğŸ”Š éŸ³å£°", "ğŸ”‡ éŸ³å£°"); }
function toggleAutoZoom(){ isAutoZoom=!isAutoZoom; updateBtn("btn-auto-zoom", isAutoZoom, "ğŸ¯ æ–°ç€è¿½å°¾", "ğŸ¯ æ–°ç€è¿½å°¾"); }
function toggleListClickZoom(){ isListClickZoom=!isListClickZoom; updateBtn("btn-list-zoom", isListClickZoom, "ğŸ‘† ã‚¯ãƒªãƒƒã‚¯", "ğŸ‘† ã‚¯ãƒªãƒƒã‚¯"); }
function togglePoints(){ isPointsVisible=!isPointsVisible; updateBtn("btn-points-toggle", isPointsVisible, "ğŸ“ è¦³æ¸¬ç‚¹", "ğŸ“ è¦³æ¸¬ç‚¹"); if(document.querySelector('.quake-item.active')) selectQuake(document.querySelector('.quake-item.active').id.replace('list-',''),'none'); }
function updateBtn(id, state, onTxt, offTxt){ const b=document.getElementById(id); b.classList.toggle("active", state); b.innerText=state?onTxt:offTxt; }
function speak(t){ if(isAudioOn){ const u=new SpeechSynthesisUtterance(t); u.lang="ja-JP"; window.speechSynthesis.speak(u); } }

function toggleTide() {
    isTideVisible = !isTideVisible;
    updateBtn("btn-tide-toggle", isTideVisible, "ğŸŒŠ æ½®ä½è¦³æ¸¬", "ğŸŒŠ æ½®ä½è¦³æ¸¬");
    const legend = document.getElementById("tide-legend");
    if (isTideVisible) { legend.style.display = "block"; renderTideStations(); } else { legend.style.display = "none"; tideLayerGroup.clearLayers(); }
}
function dmsToDecimal(s) { const m=s.match(/(\d+)Â°(\d+)â€²/); return m ? parseFloat(m[1])+(parseFloat(m[2])/60) : null; }
function renderTideStations() {
    tideLayerGroup.clearLayers();
    TIDE_STATIONS_RAW.trim().split('\n').forEach(line => {
        const c = line.split(/\t/); if (c.length < 6) return;
        const lat = dmsToDecimal(c[4]), lon = dmsToDecimal(c[5]); if (!lat) return;
        let type = 'pref'; 
        if (c[2].includes("æ°—è±¡åº")) type = 'jma'; else if (c[2].includes("æµ·ä¸Šä¿å®‰åº")) type = 'jcg'; else if (c[2].includes("åœ°ç†é™¢")) type = 'gsi'; else if (c[2].includes("æ¸¯æ¹¾å±€")) type = 'port'; else if (c[2].includes("æ°´ç®¡ç†")) type = 'riv';
        L.marker([lat, lon], { icon: L.divIcon({ className:'', html:getTideSvg(type), iconSize:[16,16] }) })
         .bindTooltip(`${c[1]}`,{direction:'top',offset:[0,-10]}).addTo(tideLayerGroup).on('click',()=>window.open(`https://www.jma.go.jp/bosai/map.html#12/${lat}/${lon}/&contents=tidelevel`,'_blank'));
    });
}

function openSettings(){
    configBackup=JSON.parse(JSON.stringify(config));
    document.getElementById("modal-overlay").style.display="block";
    renderSavedLocationsSettings();
    const g=document.getElementById("color-settings-grid"); g.innerHTML="";
    const L={10:"1",20:"2",30:"3",40:"4",45:"5-",50:"5+",55:"6-",60:"6+",70:"7"};
    Object.keys(config.colors).forEach(k=>{
        const d=document.createElement("div"); d.className="color-item";
        d.innerHTML=`<span style="font-weight:bold;width:30px;">${L[k]}</span><input type="color" value="${config.colors[k]}" oninput="config.colors[${k}]=this.value;rebuildList()">`;
        g.appendChild(d);
    });
}
function renderSavedLocationsSettings(){
    const list=document.getElementById("settings-loc-list"); list.innerHTML="";
    config.savedLocations.forEach((l,i)=>{
        const d=document.createElement("div"); d.className="loc-list-item";
        d.innerHTML=`<span>${l.name}</span><button style="background:#d32f2f;color:#fff;border:none;border-radius:2px;cursor:pointer;padding:2px 5px;" onclick="removeLocation(${i})">å‰Šé™¤</button>`;
        list.appendChild(d);
    });
}
function addLocation(){
    const n=document.getElementById("new-loc-name").value; const la=parseFloat(document.getElementById("new-loc-lat").value); const lo=parseFloat(document.getElementById("new-loc-lon").value);
    if(n&&!isNaN(la)&&!isNaN(lo)){ config.savedLocations.push({name:n,lat:la,lon:lo}); renderSavedLocationsSettings(); document.getElementById("new-loc-name").value=""; }
}
function removeLocation(i){ config.savedLocations.splice(i,1); renderSavedLocationsSettings(); }
function getCurrentLocationForInput(){ navigator.geolocation.getCurrentPosition(p=>{ document.getElementById("new-loc-lat").value=p.coords.latitude.toFixed(4); document.getElementById("new-loc-lon").value=p.coords.longitude.toFixed(4); }); }
function saveSettings(){ localStorage.setItem("jq_config_v5", JSON.stringify(config)); configBackup=null; document.getElementById("modal-overlay").style.display="none"; updateUserMarkersAndDropdown(); }
function cancelSettings(){ if(configBackup){config=configBackup; rebuildList(); updateUserMarkersAndDropdown();} document.getElementById("modal-overlay").style.display="none"; }
function updateUserMarkersAndDropdown(){
    userLocationMarkers.forEach(m=>map.removeLayer(m)); userLocationMarkers=[];
    const sel=document.getElementById("header-loc-select"); sel.innerHTML='<option value="">ğŸ“ åœ°ç‚¹...</option>';
    config.savedLocations.forEach((l,i)=>{
        const o=document.createElement("option"); o.value=i; o.textContent=l.name; sel.appendChild(o);
        const m=L.marker([l.lat,l.lon],{icon:L.divIcon({className:'user-icon',html:'<div style="background:#2196F3;width:12px;height:12px;border-radius:50%;border:2px solid white;"></div>',iconSize:[16,16]})}).addTo(map).bindTooltip(l.name);
        userLocationMarkers.push(m);
    });
}
function jumpToLocation(i){ const l=config.savedLocations[i]; if(l) map.flyTo([l.lat,l.lon],9); }
function startMapPick() { document.getElementById("modal-overlay").style.display = "none"; isPickingLocation = true; document.getElementById("map").classList.add("crosshair-cursor"); alert("åœ°å›³ä¸Šã®åœ°ç‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚"); }
function demoTsunami(){ if(!geoJsonData) { alert("åœ°å›³ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­..."); return; } handleTsunami({ code: 552, areas: [{name: "åƒè‘‰çœŒ", grade: "MajorWarning"}, {name: "æ±äº¬éƒ½", grade: "Warning"},{name: "åŒ—æµ·é“", grade: "Watch"},{name: "æ²–ç¸„çœŒ", grade: "Watch"}]}); document.getElementById("modal-overlay").style.display="none"; }
function demoEEW() {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    document.getElementById("modal-overlay").style.display = "none";
    
    // ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
    const now = new Date();
    const timeStr = `${now.getFullYear()}/${(now.getMonth()+1).toString().padStart(2,'0')}/${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;

    // æ“¬ä¼¼çš„ãªç·Šæ€¥åœ°éœ‡é€Ÿå ±ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
    // (ä¾‹: ç´€ä¼ŠåŠå³¶æ²–ã§M7.8ã®åœ°éœ‡ãŒç™ºç”Ÿã—ãŸã¨ä»®å®š)
    const mockData = {
        code: 556, // ç·Šæ€¥åœ°éœ‡é€Ÿå ±(äºˆå ±)ã‚³ãƒ¼ãƒ‰
        cancelled: false,
        earthquake: {
            originTime: timeStr,
            time: timeStr,
            hypocenter: {
                name: "ç´€ä¼ŠåŠå³¶æ²–ï¼ˆè¨“ç·´ï¼‰",
                latitude: 33.0,
                longitude: 136.0, 
                depth: 10,
                magnitude: 7.8
            },
            maxScale: 60 // æœ€å¤§éœ‡åº¦6å¼·ç›¸å½“
        },
        issue: { type: "Focus" } 
    };

    // é€šå¸¸ã®EEWå‡¦ç†ãƒ«ãƒ¼ãƒãƒ³ã«æµã™
    handleEEW(mockData);
    
    // åœ°å›³ä¸Šã®æ³¢ç´‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚é–‹å§‹
    startWaveAnimation(mockData);

    // ãƒã‚¤ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã®æ¡ˆå†…
    if (config.savedLocations.length === 0) {
        alert("ãƒã‚¤ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã¯è¡¨ç¤ºã•ã‚Œãšã€å³ä¸Šã®é€Ÿå ±è¡¨ç¤ºã®ã¿è¡Œã‚ã‚Œã¾ã™ã€‚\nã€Œè¨­å®šã€ã‹ã‚‰åœ°ç‚¹ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã®å‹•ä½œã‚‚ç¢ºèªã§ãã¾ã™ã€‚");
    }
}
function initDraggableModal(){ const m=document.getElementById("modal-window"), h=document.getElementById("modal-header-drag"); let d=false,sx,sy,il,it; h.addEventListener("mousedown",e=>{d=true;sx=e.clientX;sy=e.clientY;const r=m.getBoundingClientRect();il=r.left;it=r.top;m.style.left=il+"px";m.style.top=it+"px";m.style.transform="none";}); window.addEventListener("mousemove",e=>{if(d){m.style.left=(il+e.clientX-sx)+"px";m.style.top=(it+e.clientY-sy)+"px";}}); window.addEventListener("mouseup",()=>d=false); }
function initResizer(){ const g=document.getElementById('gutter'), c=document.getElementById('app-container'); let r=false; g.onmousedown=e=>{r=true;e.preventDefault();}; window.onmousemove=e=>{if(r){let w=Math.max(200,Math.min(600,e.clientX));c.style.gridTemplateColumns=`${w}px 6px 1fr`;map.invalidateSize();}}; window.onmouseup=()=>r=false; }
</script>

<!-- Help Modal -->
<div id="help-modal-overlay">
    <div id="help-modal-window">
        <div class="modal-header">
            <span>ğŸ“– J-Quake ãƒ˜ãƒ«ãƒ—</span>
            <button class="btn-close" id="help-modal-close">Ã—</button>
        </div>
        <div class="help-content">
            <section>
                <h3>ğŸ“Œ ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</h3>
                <p>P2Påœ°éœ‡æƒ…å ±ã®APIã‚’åˆ©ç”¨ã—ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åœ°éœ‡æƒ…å ±ãƒ»æ´¥æ³¢æƒ…å ±ãƒ»ç·Šæ€¥åœ°éœ‡é€Ÿå ±ã‚’è¡¨ç¤ºã™ã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚</p>
            </section>

            <section>
                <h3>ğŸ—ºï¸ åœ°å›³ã®è¦‹æ–¹</h3>
                <ul>
                    <li><span style="color:#2196F3; font-weight:bold;">é’ã„æ³¢ç´‹ (Pæ³¢)</span>: åˆæœŸå¾®å‹•ã€‚ã‚«ã‚¿ã‚«ã‚¿æºã‚Œã¾ã™ã€‚</li>
                    <li><span style="color:#f44336; font-weight:bold;">èµ¤ã„æ³¢ç´‹ (Sæ³¢)</span>: ä¸»è¦å‹•ã€‚ãƒ¦ã‚µãƒ¦ã‚µå¤§ããæºã‚Œã¾ã™ã€‚</li>
                    <li><strong>ä¸¸ã„ãƒãƒ¼ã‚«ãƒ¼</strong>: éœ‡æºåœ°ã‚’è¡¨ã—ã¾ã™ã€‚å††ã®å¤§ãã•ã¯ãƒã‚°ãƒ‹ãƒãƒ¥ãƒ¼ãƒ‰ã€è‰²ã¯éœ‡åº¦ã«å¯¾å¿œã—ã¾ã™ã€‚</li>
                    <li><strong>å°ã•ãªç‚¹</strong>: å„åœ°ã®éœ‡åº¦è¦³æ¸¬ç‚¹ã§ã™ã€‚</li>
                </ul>
            </section>

            <section>
                <h3>ğŸ› ï¸ ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®æ©Ÿèƒ½</h3>
                <p>åœ°å›³å·¦ä¸‹ã®ã€ŒğŸ› ï¸ è¡¨ç¤ºãƒ»ãƒ„ãƒ¼ãƒ«ã€ã‹ã‚‰ä»¥ä¸‹ã®æ©Ÿèƒ½ãŒä½¿ãˆã¾ã™ã€‚</p>
                <ul>
                    <li><strong>ğŸ¯ æ–°ç€è¿½å°¾</strong>: æ–°ã—ã„åœ°éœ‡ãŒç™ºç”Ÿã—ãŸéš›ã€è‡ªå‹•çš„ã«ãã®å ´æ‰€ã«åœ°å›³ã‚’ç§»å‹•ã—ã¾ã™ã€‚</li>
                    <li><strong>ğŸ”‡ éŸ³å£°</strong>: åœ°éœ‡ç™ºç”Ÿæ™‚ã«æƒ…å ±ã‚’èª­ã¿ä¸Šã’ã¾ã™ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®éŸ³å£°æ©Ÿèƒ½ã‚’ä½¿ç”¨ï¼‰ã€‚</li>
                    <li><strong>ğŸ“ è¦³æ¸¬ç‚¹</strong>: å„åœ°ã®éœ‡åº¦è¦³æ¸¬ç‚¹ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚</li>
                    <li><strong>ğŸŒŠ æ½®ä½è¦³æ¸¬</strong>: æ—¥æœ¬å„åœ°ã®æ½®ä½è¦³æ¸¬æ‰€ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚ã‚¯ãƒªãƒƒã‚¯ã§æ°—è±¡åºã®æ½®ä½ã‚°ãƒ©ãƒ•ã¸é£›ã³ã¾ã™ã€‚</li>
                    <li><strong>ğŸ“· ä¿å­˜</strong>: ç¾åœ¨ã®ç”»é¢ã‚’ç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚</li>
                </ul>
            </section>

            <section>
                <h3>âš™ï¸ è¨­å®šãƒ»ãƒã‚¤ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³</h3>
                <p>å³ä¸Šã®æ­¯è»Šã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰è¨­å®šã‚’è¡Œãˆã¾ã™ã€‚</p>
                <ul>
                    <li><strong>ãƒã‚¤ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³</strong>: è‡ªå®…ã‚„è·å ´ã‚’ç™»éŒ²ã—ã¦ãŠãã¨ã€ãƒªã‚¹ãƒˆã‹ã‚‰ã™ãã«åœ°å›³ç§»å‹•ã§ãã¾ã™ã€‚</li>
                    <li><strong>ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«äºˆå ±</strong>: ç·Šæ€¥åœ°éœ‡é€Ÿå ±å—ä¿¡æ™‚ã€ç™»éŒ²åœ°ç‚¹ã¸ã®åˆ°é”æ™‚é–“ã¨äºˆæ¸¬éœ‡åº¦ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</li>
                    <li><strong>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</strong>: è¨­å®šå†…å®¹ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ãƒ»å¾©å…ƒã§ãã¾ã™ã€‚</li>
                </ul>
            </section>

            <section>
                <h3>âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ»å…è²¬äº‹é …</h3>
                <p>
                    æœ¬ã‚¢ãƒ—ãƒªã®åœ°éœ‡æƒ…å ±ã¯<a href="https://www.p2pquake.net/" target="_blank" style="color:#2196F3;">P2Påœ°éœ‡æƒ…å ±</a>ã®APIã€åœ°å›³ãƒ‡ãƒ¼ã‚¿ã¯å›½åœŸåœ°ç†é™¢ãƒ»OpenStreetMapç­‰ã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚<br>
                    æƒ…å ±ã®æ­£ç¢ºæ€§ã«ã¯ä¸‡å…¨ã‚’æœŸã—ã¦ã„ã¾ã™ãŒã€æœ¬ã‚¢ãƒ—ãƒªã®åˆ©ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸæå®³ã«ã¤ã„ã¦é–‹ç™ºè€…ã¯è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚å‘½ã«é–¢ã‚ã‚‹åˆ¤æ–­ã¯ãƒ†ãƒ¬ãƒ“ãƒ»ãƒ©ã‚¸ã‚ªç­‰ã®å…¬å¼æƒ…å ±ã«å¾“ã£ã¦ãã ã•ã„ã€‚
                </p>
            </section>
            
            <section>
                <h3>â„¹ï¸ æœ€çµ‚æ›´æ–°æ—¥</h3>
                <p> 2025å¹´12æœˆ9æ—¥ </p>
            </section>
        </div>
    </div>
</div>

</body>
</html>